package com.stockbot.jp.output;

import com.stockbot.core.diagnostics.CauseCode;
import com.stockbot.core.diagnostics.Diagnostics;
import com.stockbot.core.diagnostics.FeatureResolution;
import com.stockbot.core.diagnostics.FeatureStatus;
import com.stockbot.core.diagnostics.Outcome;
import com.stockbot.jp.config.Config;
import com.stockbot.jp.indicator.IndicatorEngine;
import com.stockbot.jp.model.DataInsufficientReason;
import com.stockbot.jp.model.ScanFailureReason;
import com.stockbot.jp.model.ScanResultSummary;
import com.stockbot.jp.model.ScoredCandidate;
import com.stockbot.jp.model.WatchlistAnalysis;
import com.stockbot.jp.plan.TradePlan;
import com.stockbot.jp.plan.TradePlanBuilder;
import com.stockbot.jp.strategy.CandidateFilter;
import com.stockbot.jp.strategy.RiskFilter;
import com.stockbot.jp.strategy.ScoringEngine;
import com.stockbot.utils.TextFormatter;
import org.json.JSONArray;
import org.json.JSONObject;

import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.time.Instant;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * 讓｡蝮苓ｯｴ譏趣ｼ啌eportBuilder・・lass・峨・
 * 荳ｻ隕∬′雍｣・壽価霓ｽ output 讓｡蝮・逧・・髞ｮ騾ｻ霎托ｼ悟ｯｹ螟匁署萓帛庄螟咲畑逧・ｰ・畑蜈･蜿｣縲・
 * 菴ｿ逕ｨ蟒ｺ隶ｮ・壻ｿｮ謾ｹ隸･邀ｻ蝙区慮蠎泌酔豁･蜈ｳ豕ｨ荳贋ｸ区ｸｸ隹・畑・碁∩蜈榊ｽｱ蜩肴紛菴捺ｵ∫ｨ狗ｨｳ螳壽ｧ縲・
 */
public final class ReportBuilder {
    private static final DateTimeFormatter FILE_TS = DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss");
    private static final DateTimeFormatter DISPLAY_TS = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    private static final LocalTime CLOSE_TIME = LocalTime.of(15, 0);
    private static final List<String> DERIVATIVE_KEYWORDS = List.of(
            "ETF", "ETN", "REIT", "INV", "INVERSE", "LEVERAGE", "LEVERAGED",
            "BEAR", "BULL", "DOUBLE", "TRIPLE", "INDEX LINKED", "HEDGE"
    );
    private static final String OWNER_TOP5 = "com.stockbot.jp.output.ReportBuilder#buildTopSelection(...)";

    private final Config config;
    private final TradePlanBuilder tradePlanBuilder;

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啌eportBuilder・瑚ｴ溯ｴ｣蛻晏ｧ句喧蟇ｹ雎｡蟷ｶ陬・・萓晁ｵ門盾謨ｰ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    public ReportBuilder(Config config) {
        this.config = config;
        this.tradePlanBuilder = new TradePlanBuilder(config);
    }

    public enum RunType {
        INTRADAY,
        CLOSE
    }

    private enum RiskGrade {
        LOW,
        MID,
        HIGH
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ單etectRunType・瑚ｴ溯ｴ｣譽豬区擅莉ｶ蟷ｶ霎灘・蛻､譁ｭ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    public static RunType detectRunType(Instant startedAt, ZoneId zoneId) {
        if (startedAt == null || zoneId == null) {
            return RunType.CLOSE;
        }
        return startedAt.atZone(zoneId).toLocalTime().isBefore(CLOSE_TIME) ? RunType.INTRADAY : RunType.CLOSE;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗹riteDailyReport・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    public Path writeDailyReport(
            Path reportDir,
            Instant startedAt,
            ZoneId zoneId,
            int universeSize,
            int scannedSize,
            int candidateSize,
            int topN,
            List<String> watchlist,
            List<WatchlistAnalysis> watchlistCandidates,
            List<ScoredCandidate> marketReferenceCandidates,
            double minScore,
            RunType runType,
            Map<String, Double> previousScoreByTicker,
            ScanResultSummary scanSummary,
            boolean marketScanPartial,
            String marketScanStatus,
            Diagnostics diagnostics
    ) throws Exception {
        Files.createDirectories(reportDir);
        String ts = FILE_TS.format(startedAt.atZone(zoneId));
        Path report = reportDir.resolve("jp_daily_" + ts + ".html");
        String html = buildHtml(
                startedAt,
                zoneId,
                universeSize,
                scannedSize,
                candidateSize,
                topN,
                watchlist,
                watchlistCandidates,
                marketReferenceCandidates,
                minScore,
                runType,
                previousScoreByTicker,
                scanSummary,
                marketScanPartial,
                marketScanStatus,
                diagnostics
        );
        Files.writeString(report, html, StandardCharsets.UTF_8);
        Files.writeString(reportDir.resolve("email_main.html"), html, StandardCharsets.UTF_8);
        String debugJson = buildDebugJson(
                startedAt,
                zoneId,
                watchlistCandidates,
                scanSummary,
                marketScanPartial,
                marketScanStatus,
                diagnostics
        );
        Files.writeString(reportDir.resolve("report_debug.json"), debugJson, StandardCharsets.UTF_8);
        return report;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喘uildHtml・瑚ｴ溯ｴ｣譫・ｻｺ逶ｮ譬・ｯｹ雎｡謌冶ｾ灘・蜀・ｮｹ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    public String buildHtml(
            Instant startedAt,
            ZoneId zoneId,
            int universeSize,
            int scannedSize,
            int candidateSize,
            int topN,
            List<String> watchlist,
            List<WatchlistAnalysis> watchlistCandidates,
            List<ScoredCandidate> marketReferenceCandidates,
            double minScore,
            RunType runType,
            Map<String, Double> previousScoreByTicker,
            ScanResultSummary scanSummary,
            boolean marketScanPartial,
            String marketScanStatus,
            Diagnostics diagnostics
    ) {
        List<WatchlistAnalysis> watchRows = sortedWatch(watchlistCandidates);
        Diagnostics diag = diagnostics == null ? new Diagnostics(0L, "") : diagnostics;
        ScanResultSummary summary = scanSummary == null
                ? new ScanResultSummary(0, 0, 0, Map.of(), Map.of(), Map.of())
                : scanSummary;
        Diagnostics.CoverageMetric fetchCoverageMetric = diag.selectedFetchCoverage();
        Diagnostics.CoverageMetric indicatorCoverageMetric = diag.selectedIndicatorCoverage();
        Diagnostics.CoverageMetric marketRunFetchMetric = diag.coverages.get("market_scan_fetch_coverage");
        Diagnostics.CoverageMetric watchlistFetchMetric = diag.coverages.get("watchlist_fetch_coverage");
        int fetchCoverageDenominator = fetchCoverageMetric == null ? universeSize : fetchCoverageMetric.denominator;
        int indicatorCoverageDenominator = indicatorCoverageMetric == null ? universeSize : indicatorCoverageMetric.denominator;
        int fetchCoverageCount = fetchCoverageMetric == null ? Math.max(0, summary.fetchCoverage) : fetchCoverageMetric.numerator;
        int indicatorCoverageCount = indicatorCoverageMetric == null ? Math.max(0, summary.indicatorCoverage) : indicatorCoverageMetric.numerator;
        double fetchCoveragePct = fetchCoverageMetric == null ? coveragePct(universeSize, fetchCoverageCount) : fetchCoverageMetric.pct;
        double indicatorCoveragePct = indicatorCoverageMetric == null ? coveragePct(universeSize, indicatorCoverageCount) : indicatorCoverageMetric.pct;
        String coverageScope = blankTo(diag.coverageScope, "MARKET");
        String coverageSource = blankTo(diag.coverageSource, "UNKNOWN");
        String marketRunCoverage = formatCoverage(marketRunFetchMetric);
        String watchlistCoverage = formatCoverage(watchlistFetchMetric);
        int marketRunDenominator = marketRunFetchMetric == null ? fetchCoverageDenominator : marketRunFetchMetric.denominator;
        boolean showCoverageScope = config.getBoolean("report.coverage.show_scope", true);
        String coverageScopeLabel = showCoverageScope
                ? coverageScope + "(" + ("WATCHLIST".equalsIgnoreCase(coverageScope)
                ? String.valueOf(fetchCoverageDenominator)
                : ("JP scan " + marketRunDenominator)) + ")"
                : coverageScope;

        CandidateSelection topSelection = buildTopSelection(
                sortedMarket(marketReferenceCandidates),
                runType,
                previousScoreByTicker,
                minScore,
                5,
                candidateSize,
                marketScanPartial,
                fetchCoveragePct,
                safe(marketScanStatus),
                diag
        );

        ActionAdvice advice = actionAdviceV2(fetchCoveragePct, indicatorCoveragePct, candidateSize, topSelection.cards);
        int horizonDays = Math.max(1, config.getInt("backtest.hold_days", 10));
        double singleMaxPct = clamp(config.getDouble("report.position.max_single_pct", config.getDouble("position.single.maxPct", 0.05) * 100.0), 0.0, 100.0) / 100.0;
        double totalMaxPct = clamp(config.getDouble("report.position.max_total_pct", config.getDouble("position.total.maxPct", 0.50) * 100.0), 0.0, 100.0) / 100.0;
        boolean isClose = runType == RunType.CLOSE;
        boolean hideEntryInIntraday = config.getBoolean("report.mode.intraday.hideEntry", true);

        StringBuilder sb = new StringBuilder(64_000);
        appendPageHeader(sb);
        appendTopHeader(
                sb,
                startedAt,
                zoneId,
                horizonDays,
                universeSize,
                candidateSize,
                topN,
                runType,
                fetchCoverageCount,
                fetchCoverageDenominator,
                fetchCoveragePct,
                indicatorCoverageCount,
                indicatorCoverageDenominator,
                indicatorCoveragePct,
                coverageScopeLabel,
                coverageSource,
                summary,
                watchRows,
                marketRunCoverage,
                watchlistCoverage,
                marketScanPartial,
                marketScanStatus,
                marketRunDenominator
        );
        appendNoviceDecisionCard(sb, advice, fetchCoveragePct, indicatorCoveragePct, runType, watchRows, topSelection, diag);
        appendActionAdvice(sb, advice, singleMaxPct, totalMaxPct);
        appendWatchTableV2(sb, watchRows, isClose);
        appendWatchAiSummary(sb, watchRows);
        appendTopCardsV2(sb, topSelection, isClose, hideEntryInIntraday, diag);
        appendDisclaimer(sb);
        appendConfigOverviewCollapsed(sb, diag);
        appendDiagnosticsCollapsed(sb, diag);
        appendSystemStatus(sb, summary, diag);
        appendSystemRunLogs(
                sb,
                summary,
                fetchCoverageCount,
                fetchCoverageDenominator,
                fetchCoveragePct,
                indicatorCoverageCount,
                indicatorCoverageDenominator,
                indicatorCoveragePct,
                marketRunCoverage,
                watchlistCoverage,
                coverageSource,
                marketScanPartial,
                marketScanStatus,
                marketRunDenominator,
                watchRows
        );
        sb.append("</div></body></html>");
        return sb.toString();
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喘uildMailText・瑚ｴ溯ｴ｣譫・ｻｺ逶ｮ譬・ｯｹ雎｡謌冶ｾ灘・蜀・ｮｹ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    public String buildMailText(
            Instant startedAt,
            ZoneId zoneId,
            int universeSize,
            int scannedSize,
            int candidateSize,
            int topN,
            List<WatchlistAnalysis> watchlistCandidates,
            List<ScoredCandidate> marketReferenceCandidates,
            List<String> watchlist,
            double minScore
    ) {
        double coverage = coveragePct(universeSize, scannedSize);
        return String.format(Locale.US, "StockBot JP report | run=%s | coverage=%.1f%% | candidates=%d | topN=%d",
                DISPLAY_TS.format(startedAt.atZone(zoneId)), coverage, candidateSize, topN);
    }

    public String buildNoviceActionSummary(double indicatorCoveragePct, RunType runType, List<WatchlistAnalysis> watchRows) {
        boolean isClose = runType == RunType.CLOSE;
        List<WatchDecisionRow> rows = new ArrayList<>();
        if (watchRows != null) {
            for (WatchlistAnalysis row : watchRows) {
                rows.add(new WatchDecisionRow(row, decideForWatchAction(row, isClose)));
            }
        }
        rows.sort(Comparator
                .comparingInt((WatchDecisionRow x) -> watchActionPriority(x.decision.action)).reversed()
                .thenComparingDouble(x -> x.row == null ? 0.0 : x.row.technicalScore).reversed());

        StringBuilder sb = new StringBuilder(512);
        sb.append("莉頑律扈楢ｮｺ・・).append(noviceConclusion(indicatorCoveragePct)).append("\n");
        int count = 0;
        for (WatchDecisionRow row : rows) {
            if (row == null || row.decision == null || "WAIT".equals(row.decision.action)) {
                continue;
            }
            WatchlistAnalysis w = row.row;
            TradePlan p = row.decision.plan;
            String reason = row.decision.reason1 + (blankTo(row.decision.reason2, "").isEmpty() ? "" : ("・・ + row.decision.reason2));
            sb.append("[")
                    .append(row.decision.action)
                    .append("] ")
                    .append(safeText(plainCode(w)))
                    .append(" ")
                    .append(safeText(plainName(w)))
                    .append(" 邇ｰ莉ｷ")
                    .append(fmt2(w == null ? Double.NaN : w.lastClose))
                    .append(" 豁｢謐・)
                    .append(p != null && p.valid ? fmt2(p.stopLoss) : "-")
                    .append(" 逶ｮ譬・)
                    .append(p != null && p.valid ? fmt2(p.takeProfit) : "-")
                    .append(" 逅・罰:")
                    .append(safeText(reason))
                    .append("\n");
            count++;
            if (count >= 5) {
                break;
            }
        }
        if (count == 0) {
            sb.append("莉頑律譌譏守｡ｮ蜉ｨ菴懶ｼ井ｻ・ｧょｯ滂ｼ・);
        }
        return sb.toString().trim();
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendPageHeader・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendPageHeader(StringBuilder sb) {
        sb.append("<!doctype html><html><head><meta charset='UTF-8'><style>");
        sb.append("body{margin:0;background:#eef4f8;color:#12263a;font-family:'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif;}");
        sb.append(".wrap{max-width:1120px;margin:20px auto;background:#fff;border:1px solid #d7e2eb;border-radius:14px;padding:18px 20px 24px;}");
        sb.append("h1{margin:0 0 10px;font-size:26px;}h2{margin:18px 0 10px;font-size:20px;}h3{margin:8px 0;font-size:16px;}");
        sb.append(".grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}.tile{border:1px solid #dbe6ef;border-radius:10px;background:#fbfdff;padding:10px;}");
        sb.append(".k{font-size:12px;color:#4b5d73;margin-bottom:4px;}.v{font-size:17px;font-weight:700;}.small{font-size:12px;color:#5b6c80;line-height:1.6;}");
        sb.append(".chip{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;font-weight:700;}");
        sb.append(".good{background:#dcfce7;color:#166534;}.warn{background:#fef3c7;color:#92400e;}.bad{background:#fee2e2;color:#991b1b;}.info{background:#dbeafe;color:#1d4ed8;}.gray{background:#e5e7eb;color:#374151;}");
        sb.append("table{width:100%;border-collapse:collapse;font-size:13px;}th,td{border:1px solid #d9e4ee;padding:8px;text-align:left;vertical-align:top;}th{background:#f3f7fb;font-weight:700;}");
        sb.append(".card{border:1px solid #dbe6ef;border-radius:12px;background:#fcfeff;padding:12px;margin-top:10px;}.warnbox{border:1px solid #f3d7a1;background:#fff7ea;color:#8b5e00;border-radius:10px;padding:10px;margin-top:8px;}");
        sb.append(".dangerbox{border:1px solid #fecaca;background:#fff1f2;color:#991b1b;border-radius:10px;padding:10px;margin-top:8px;}");
        sb.append(".suspect{background:#fff8f8;} details{margin-top:6px;} summary{cursor:pointer;}");
        sb.append(".bul{margin:6px 0 0 16px;padding:0;} .bul li{margin:3px 0;}.disclaimer{font-size:12px;line-height:1.7;color:#5b6c80;border-top:1px solid #e1eaf2;margin-top:14px;padding-top:10px;}");
        sb.append("@media (max-width:720px){.wrap{margin:8px;border-radius:8px;padding:12px;}h1{font-size:20px;}th,td{font-size:12px;padding:6px;}}");
        sb.append("</style></head><body><div class='wrap'>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendTopHeader・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
        private void appendTopHeader(
            StringBuilder sb,
            Instant startedAt,
            ZoneId zoneId,
            int horizonDays,
            int universeSize,
            int candidateSize,
            int topN,
            RunType runType,
            int fetchCoverageCount,
            int fetchCoverageDenominator,
            double fetchCoveragePct,
            int indicatorCoverageCount,
            int indicatorCoverageDenominator,
            double indicatorCoveragePct,
            String coverageScope,
            String coverageSource,
            ScanResultSummary summary,
            List<WatchlistAnalysis> watchRows,
            String marketRunCoverage,
            String watchlistCoverage,
            boolean marketScanPartial,
            String marketScanStatus,
            int marketRunDenominator
    ) {
        sb.append("<h1>StockBot 每日研判报告</h1>");
        sb.append("<h2>A. 顶部 Header</h2>");
        sb.append("<div class='grid'>");
        sb.append(tile("运行时间 (JST)", escape(DISPLAY_TS.format(startedAt.atZone(zoneId)))));
        sb.append(tile("预测周期", horizonDays + " 天"));
        sb.append(tile("今日候选数量", String.valueOf(candidateSize)));
        sb.append(tile("今日 TopN 数量", String.valueOf(topN)));
        sb.append(tile("邮件类型", runType == RunType.CLOSE ? "CLOSE (15:00)" : "INTRADAY (11:30)"));
        sb.append("</div>");

        int suspect = countPriceSuspects(watchRows);
        if (suspect > 0) {
            sb.append("<div class='dangerbox'>Possible price mapping issue: same lastClose repeated across tickers.</div>");
            sb.append("<div class='small'>suspect tickers: ").append(escape(joinSuspectTickers(watchRows))).append("</div>");
        }
    }
    private void appendSystemStatus(StringBuilder sb, ScanResultSummary summary, Diagnostics diagnostics) {
        sb.append("<h2>I. 邉ｻ扈溽憾諤∬ｯｴ譏・/h2>");
        sb.append("<div class='small'>");
        sb.append("1) 扈ｼ蜷亥・驥冗ｺｲ扈滉ｸ荳ｺ <b>0~100</b>・郁・騾芽ぃ荳主・蟶ょ惻荳閾ｴ・峨・br>");
        sb.append("2) 謖・・ｼ墓梼・・).append(escape(String.join(", ", IndicatorEngine.computedIndicators()))).append("<br>");
        sb.append("3) 遲幃画ｨ｡蝮・CandidateFilter)・喇ard 譚｡莉ｶ + signals・敬ard=")
                .append(escape(String.join(", ", CandidateFilter.hardRuleNames())))
                .append("・茎ignals=")
                .append(escape(String.join(", ", CandidateFilter.signalRuleNames())))
                .append("<br>");
        sb.append("4) 鬟取而讓｡蝮・RiskFilter)・・)
                .append(escape(String.join(", ", RiskFilter.riskFlagNames())))
                .append("<br>");
        sb.append("5) 隸・・讓｡蝮・ScoringEngine)・・)
                .append(escape(String.join(", ", ScoringEngine.factorNames())))
                .append("・・isk penalty clamp 0..100・・br>");
        sb.append("6) 蠖灘燕蜈ｳ髞ｮ髦亥ｼ・・)
                .append("scan.min_score=").append(escape(config.getString("scan.min_score"))).append("・・)
                .append("filter.min_signals=").append(escape(config.getString("filter.min_signals"))).append("・・)
                .append("filter.hard.max_drop_3d_pct=").append(escape(config.getString("filter.hard.max_drop_3d_pct"))).append("・・)
                .append("rr.min=").append(escape(config.getString("rr.min"))).append("・・)
                .append("plan.entry.buffer_pct=").append(escape(config.getString("plan.entry.buffer_pct"))).append("・・)
                .append("plan.stop.atr_mult=").append(escape(config.getString("plan.stop.atr_mult")))
                .append("<br>");

        FeatureResolution perf = diagnostics == null ? null : diagnostics.feature("report.metrics.top5_perf");
        if (perf == null) {
            perf = new FeatureResolution(
                    "report.metrics.top5_perf.enabled",
                    config.getBoolean("report.metrics.top5_perf.enabled", false),
                    false,
                    FeatureStatus.DISABLED_NOT_IMPLEMENTED,
                    CauseCode.FEATURE_NOT_IMPLEMENTED,
                    OWNER_TOP5,
                    "feature not implemented",
                    ""
            );
        }
        sb.append("7) 霑・0譌･ Top5 閭懃紫/譛螟ｧ蝗樊彫・・)
                .append(renderFeatureStatusV2("report.metrics.top5_perf.enabled", perf, summary))
                .append("<br>");
        sb.append("</div>");
    }

    private void appendSystemRunLogs(
            StringBuilder sb,
            ScanResultSummary summary,
            int fetchCoverageCount,
            int fetchCoverageDenominator,
            double fetchCoveragePct,
            int indicatorCoverageCount,
            int indicatorCoverageDenominator,
            double indicatorCoveragePct,
            String marketRunCoverage,
            String watchlistCoverage,
            String coverageSource,
            boolean marketScanPartial,
            String marketScanStatus,
            int marketRunDenominator,
            List<WatchlistAnalysis> watchRows
    ) {
        sb.append("<details><summary>系统运行日志</summary><div class='small'>");
        sb.append("FETCH_COVERAGE ").append(fetchCoverageCount).append(" / ").append(fetchCoverageDenominator)
                .append(" (").append(fmt1(fetchCoveragePct)).append("%)<br>");
        sb.append("INDICATOR_COVERAGE ").append(indicatorCoverageCount).append(" / ").append(indicatorCoverageDenominator)
                .append(" (").append(fmt1(indicatorCoveragePct)).append("%)<br>");
        sb.append("market_run_coverage ").append(escape(blankTo(marketRunCoverage, "-"))).append("<br>");
        sb.append("watchlist_coverage ").append(escape(blankTo(watchlistCoverage, "-"))).append("<br>");
        sb.append("coverage_source=").append(escape(blankTo(coverageSource, "UNKNOWN"))).append("<br>");
        int timeout = summary == null ? 0 : summary.requestFailureCount(ScanFailureReason.TIMEOUT);
        int noData = summary == null ? 0 : summary.requestFailureCount(ScanFailureReason.HTTP_404_NO_DATA) + summary.failureCount(ScanFailureReason.HTTP_404_NO_DATA);
        int parseError = summary == null ? 0 : summary.requestFailureCount(ScanFailureReason.PARSE_ERROR);
        int stale = summary == null ? 0 : summary.failureCount(ScanFailureReason.STALE);
        int historyShort = summary == null ? 0 : summary.failureCount(ScanFailureReason.HISTORY_SHORT);
        int nonTradable = summary == null ? 0 : summary.failureCount(ScanFailureReason.FILTERED_NON_TRADABLE);
        int rateLimit = summary == null ? 0 : summary.requestFailureCount(ScanFailureReason.RATE_LIMIT);
        int other = summary == null ? 0 : summary.failureCount(ScanFailureReason.OTHER) + summary.requestFailureCount(ScanFailureReason.OTHER);
        sb.append("failure_breakdown: ")
                .append("timeout=").append(timeout)
                .append(" | http_404/no_data=").append(noData)
                .append(" | parse_error=").append(parseError)
                .append(" | stale=").append(stale)
                .append(" | history_short=").append(historyShort)
                .append(" | filtered_non_tradable=").append(nonTradable)
                .append(" | rate_limit=").append(rateLimit)
                .append(" | other=").append(other)
                .append("<br>");
        if (marketScanPartial || "PARTIAL".equalsIgnoreCase(blankTo(marketScanStatus, ""))) {
            sb.append("market_scan=PARTIAL (effective_denominator=").append(Math.max(0, marketRunDenominator)).append(")<br>");
        }

        if (watchRows != null && !watchRows.isEmpty()) {
            sb.append("<b>watchlist_fetch_trace</b><br>");
            for (WatchlistAnalysis row : watchRows) {
                if (row == null) {
                    continue;
                }
                JSONObject trace = safeJson(row.technicalReasonsJson).optJSONObject("fetch_trace");
                sb.append(escape(watchName(row))).append(": ");
                sb.append("data_source=").append(escape(blankTo(row.dataSource, "-"))).append(" | ");
                sb.append("price_timestamp=").append(escape(blankTo(row.priceTimestamp, "-"))).append(" | ");
                sb.append("bars_count=").append(row.barsCount).append(" | ");
                sb.append("cache_hit=").append(row.cacheHit).append(" | ");
                sb.append("fetch_latency_ms=").append(row.fetchLatencyMs);
                if (trace != null) {
                    sb.append(" | ticker_normalized=").append(escape(trace.optString("ticker_normalized", "")));
                    sb.append(" | resolved_exchange=").append(escape(trace.optString("resolved_exchange", "")));
                    sb.append(" | fallback_path=").append(escape(trace.optString("fallback_path", "")));
                }
                sb.append("<br>");
            }
        }
        sb.append("</div></details>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendActionAdvice・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendActionAdvice(StringBuilder sb, ActionAdvice advice, double singleMaxPct, double totalMaxPct) {
        sb.append("<h2>C. 莉頑律陦悟勘蟒ｺ隶ｮ・域ｻ隗茨ｼ・/h2>");
        sb.append("<div class='card'>");
        sb.append("<div>蟒ｺ隶ｮ遲臥ｺｧ・・span class='chip ").append(advice.css).append("'>").append(escape(advice.level)).append("</span></div>");
        sb.append("<div class='small' style='margin-top:6px;'>").append(escape(advice.reason)).append("</div>");
        sb.append("<div class='small' style='margin-top:6px;'>譁ｰ謇倶ｻ謎ｽ堺ｸ企剞・壼黒隨・竕､ ").append(fmt1(singleMaxPct * 100.0))
                .append("%・梧ｻ莉・竕､ ").append(fmt1(totalMaxPct * 100.0)).append("%</div>");
        sb.append("</div>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendWatchTable・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendNoviceDecisionCard(
            StringBuilder sb,
            ActionAdvice advice,
            double fetchCoveragePct,
            double indicatorCoveragePct,
            RunType runType,
            List<WatchlistAnalysis> watchRows,
            CandidateSelection topSelection,
            Diagnostics diag
    ) {
        WatchDecisionRow best = pickBestWatchDecision(watchRows, runType == RunType.CLOSE);
        sb.append("<h2>B. 莉頑律蜀ｳ遲門今</h2><div class='card'>");
        sb.append("<div class='small'>1) 莉頑律扈楢ｮｺ・・b>").append(escape(noviceConclusion(indicatorCoveragePct))).append("</b></div>");
        if (best == null || best.decision == null || "WAIT".equals(best.decision.action)) {
            sb.append("<div class='small'>2) 莉頑律譛蛟ｼ蠕礼恚逧・・騾芽ぃ・壽裏・井ｻ頑律菫｡蜿ｷ荳崎ｶｳ・・/div>");
        } else {
            sb.append("<div class='small'>2) 莉頑律譛蛟ｼ蠕礼恚逧・・騾芽ぃ・・)
                    .append(escape(watchName(best.row)))
                    .append(" [")
                    .append(escape(best.decision.action))
                    .append("]</div>");
        }
        sb.append("<div class='small'>3) 莉頑律荵ｰ蜈･譚｡莉ｶ・壼・謨ｰ竕･80 荳・菫｡蜿ｷ=隗ｦ蜿・/div>");
        sb.append("<div class='small'>4) 莉頑律荵ｰ蜈･譚｡莉ｶ・夐｣朱勦竕鬮・/div>");
        sb.append("<div class='small'>5) 莉頑律荵ｰ蜈･譚｡莉ｶ・壽怏蜈･蝨ｺ/豁｢謐滂ｼ・lan valid・・/div>");
        sb.append("<div class='small'>6) 莉頑律蜊門・/蜃丈ｻ捺擅莉ｶ・夊ｷ檎ｴ豁｢謐・-> 逶ｴ謗･豁｢謐・/div>");
        sb.append("<div class='small'>7) 莉頑律蜊門・/蜃丈ｻ捺擅莉ｶ・壼・謨ｰ霍檎ｴ65 荳・鬟朱勦=鬮・-> 蜃丈ｻ・騾蜃ｺ</div>");
        if (indicatorCoveragePct < 50.0) {
            sb.append("<div class='small'>8) 謨ｰ謐ｮ蜿ｯ菫｡蠎ｦ・壽欠譬・ｦ・尠荳崎ｶｳ・・).append(fmt1(indicatorCoveragePct)).append("%・会ｼ御ｻ頑律荳崎ｦ∽ｾ晄紺 Top5 蛛壻ｺ､譏・/div>");
        } else {
            sb.append("<div class='small'>8) 謨ｰ謐ｮ蜿ｯ菫｡蠎ｦ・壽欠譬・ｦ・尠豁｣蟶ｸ・・).append(fmt1(indicatorCoveragePct)).append("%・会ｼ悟庄蜿り・Top5・御ｽ・ｻ埼怙謖画ｭ｢謐滓鴬陦・/div>");
        }
        sb.append("</div>");
    }

    private void appendWatchTableV2(StringBuilder sb, List<WatchlistAnalysis> watchRows, boolean isClose) {
        sb.append("<h2>D. 閾ｪ騾芽ぃ蜉ｨ菴懆｡ｨ</h2>");
        sb.append("<table><tr>")
                .append("<th>莉｣遐・蜷咲ｧｰ</th>")
                .append("<th>譛譁ｰ莉ｷ</th>")
                .append("<th>謌醍噪蜉ｨ菴・/th>")
                .append("<th>逅・罰・域怙螟・譚｡・・/th>")
                .append("<th>蜈･蝨ｺ蛹ｺ髣ｴ</th>")
                .append("<th>豁｢謐滉ｽ・/th>")
                .append("<th>逶ｮ譬・ｽ・/th>")
                .append("</tr>");
        if (watchRows == null || watchRows.isEmpty()) {
            sb.append("<tr><td colspan='7'>譌閾ｪ騾芽ぃ謨ｰ謐ｮ</td></tr></table>");
            return;
        }
        for (WatchlistAnalysis row : watchRows) {
            WatchDecision decision = decideForWatchAction(row, isClose);
            TradePlan plan = decision.plan;

            sb.append("<tr").append(row != null && row.priceSuspect ? " class='suspect'" : "").append("><td>");
            sb.append(escape(watchName(row)));
            sb.append("</td>");

            sb.append("<td>").append(fmt2(row == null ? Double.NaN : row.lastClose)).append("</td>");
            sb.append("<td><span class='chip ").append(watchActionCss(decision.action)).append("'>").append(escape(decision.action)).append("</span></td>");
            sb.append("<td><div class='small'>- ").append(escape(decision.reason1)).append("</div>");
            if (!blankTo(decision.reason2, "").isEmpty()) {
                sb.append("<div class='small'>- ").append(escape(decision.reason2)).append("</div>");
            }
            sb.append("</td>");
            sb.append("<td>").append(isClose && plan != null && plan.valid ? (fmt2(plan.entryLow) + " ~ " + fmt2(plan.entryHigh)) : "-").append("</td>");
            sb.append("<td>").append(plan != null && plan.valid ? formatPlanLevelWithDelta(plan.stopLoss, row == null ? Double.NaN : row.lastClose, true) : "-").append("</td>");
            sb.append("<td>").append(plan != null && plan.valid ? formatPlanLevelWithDelta(plan.takeProfit, row == null ? Double.NaN : row.lastClose, false) : "-").append("</td>");
            sb.append("</tr>");
        }
        sb.append("</table>");
    }

    private void appendWatchTable(StringBuilder sb, List<WatchlistAnalysis> watchRows, boolean isClose) {
        sb.append("<h2>D. 閾ｪ騾芽ぃ霍溯ｸｪ・育ｲｾ邂陦ｨ譬ｼ・・/h2>");
        sb.append("<table><tr><th>莉｣遐・蜷咲ｧｰ</th><th>譛譁ｰ莉ｷ</th><th>扈ｼ蜷亥・(0-100)</th><th>鬟朱勦遲臥ｺｧ</th><th>菫｡蜿ｷ迥ｶ諤・/th><th>")
                .append(isClose ? "豁｢謐滉ｽ・ : "鬟朱勦郤ｿ(豁｢謐滓э荵・").append("</th></tr>");
        if (watchRows.isEmpty()) {
            sb.append("<tr><td colspan='6'>譌閾ｪ騾芽ぃ謨ｰ謐ｮ縲・/td></tr></table>");
            return;
        }
        for (WatchlistAnalysis row : watchRows) {
            IndicatorData ind = parseIndicators(row.technicalIndicatorsJson, row.lastClose);
            RiskAssessment risk = assessRisk(ind);
            Outcome<TradePlan> planOutcome = tradePlanBuilder.build(toTradePlanInput(ind));
            TradePlan plan = planOutcome.value == null ? TradePlan.invalid() : planOutcome.value;
            String signal = "CANDIDATE".equalsIgnoreCase(blankTo(row.technicalStatus, "")) ? "隗ｦ蜿・ : "譛ｪ隗ｦ蜿・;
            String riskCss = risk.grade == RiskGrade.HIGH ? "bad" : (risk.grade == RiskGrade.MID ? "warn" : "good");
            JSONObject reasonRoot = safeJson(row.technicalReasonsJson);
            DisplayReason displayReason = resolveDisplayReason(row, reasonRoot, planOutcome);
            JSONObject fetchTrace = reasonRoot.optJSONObject("fetch_trace");
            sb.append("<tr").append(row.priceSuspect ? " class='suspect'" : "").append("><td>");
            sb.append(escape(watchName(row)));
            if (row.priceSuspect) {
                sb.append(" <span class='chip bad'>SUSPECT</span>");
            }
            sb.append("<details><summary class='small'>trace</summary><div class='small'>");
            sb.append("data_source=").append(escape(row.dataSource)).append(" | ");
            sb.append("price_timestamp=").append(escape(row.priceTimestamp)).append(" | ");
            sb.append("bars_count=").append(row.barsCount).append(" | ");
            sb.append("cache_hit=").append(row.cacheHit).append(" | ");
            sb.append("fetch_latency_ms=").append(row.fetchLatencyMs);
            if (fetchTrace != null) {
                sb.append(" | ticker_normalized=").append(escape(fetchTrace.optString("ticker_normalized", "")));
                sb.append(" | resolved_exchange=").append(escape(fetchTrace.optString("resolved_exchange", "")));
                sb.append(" | fetcher_class=").append(escape(fetchTrace.optString("fetcher_class", "")));
                sb.append(" | fallback_path=").append(escape(fetchTrace.optString("fallback_path", "")));
            }
            sb.append("</div></details>");
            appendWatchWhy(sb, displayReason);
            sb.append("</td>");
            sb.append("<td>").append(fmt2(row.lastClose)).append("</td>");
            sb.append("<td><span class='chip info'>").append(fmt1(row.technicalScore)).append("</span> ").append(escape(scoreTier(row.technicalScore))).append("</td>");
            sb.append("<td><span class='chip ").append(riskCss).append("'>").append(escape(riskText(risk))).append("</span></td>");
            sb.append("<td>").append(escape(signal)).append("</td>");
            sb.append("<td>").append(escape(plan.valid ? fmt2(plan.stopLoss) : displayReason.category)).append("</td></tr>");
        }
        sb.append("</table>");
        sb.append("<div class='small' style='margin-top:8px;'>隸ｴ譏趣ｼ售MA/RSI/ATR/BB% 遲牙次蟋区欠譬・ｸ榊惠豁｣譁・ｱ慕､ｺ縲・/div>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendWatchAiSummary・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendWatchAiSummary(StringBuilder sb, List<WatchlistAnalysis> watchRows) {
        if (watchRows.isEmpty()) return;
        sb.append("<div class='card'><h3 style='margin-top:0;'>AI 譁ｰ髣ｻ鞫倩ｦ・ｼ育ｺｯ譁・悽・・/h3>");
        for (WatchlistAnalysis row : watchRows) {
            sb.append("<div style='margin-bottom:8px;'><b>").append(escape(watchName(row))).append("</b>");
            for (String line : aiSummaryLines(row)) {
                sb.append("<div class='small'>").append(escape(line)).append("</div>");
            }
            if (row.newsDigests != null && !row.newsDigests.isEmpty()) {
                sb.append("<details><summary class='small'>逶ｸ蜈ｳ譁ｰ髣ｻ</summary>");
                for (String digest : row.newsDigests) {
                    String line = sanitizeInlineText(digest);
                    if (line.isEmpty()) {
                        continue;
                    }
                    sb.append("<div class='small'>- ").append(escape(line)).append("</div>");
                }
                sb.append("</details>");
            }
            sb.append("</div>");
        }
        sb.append("</div>");
    }
/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendTopCards・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendTopCardsV2(StringBuilder sb, CandidateSelection topSelection, boolean isClose, boolean hideEntryInIntraday, Diagnostics diagnostics) {
        sb.append("<h2>E. 莉頑律 Top5</h2>");
        appendTopFunnel(sb, topSelection.funnel, topSelection.skipReason, diagnostics);
        boolean noviceWarn = topSelection.cards.stream().anyMatch(c -> c.risk.grade == RiskGrade.HIGH || containsRiskTag(c.risk.tags, "HIGH_VOL") || containsRiskTag(c.risk.tags, "DOWN_TREND"));
        if (noviceWarn) {
            sb.append("<div class='warnbox'>Top5 螟壻ｸｺ鬮俶ｳ｢蜉ｨ/荳玖ｷ瑚ｶ句漢蜿榊ｼｹ逾ｨ・梧眠謇矩ｻ倩ｮ､荳榊盾荳趣ｼ井ｻ・ｧょｯ滂ｼ・/div>");
        }
        if (topSelection.cards.isEmpty()) {
            sb.append("<div class='warnbox'>陦梧ュ/謖・・ｼｺ螟ｱ・壻ｻ頑律莉・ｧょｯ滂ｼ御ｸ堺ｺ､譏・/div>");
            return;
        }
        for (CandidateCard card : topSelection.cards) {
            String riskCss = card.risk.grade == RiskGrade.HIGH ? "bad" : (card.risk.grade == RiskGrade.MID ? "warn" : "good");
            sb.append("<div class='card'><div><b>#").append(card.rank).append(" ").append(escape(card.name)).append("</b></div>");
            sb.append("<div class='small'>譛譁ｰ莉ｷ ").append(fmt2(card.latestPrice))
                    .append(" | 隸・・ <span class='chip info'>").append(fmt1(card.score)).append("</span>")
                    .append(" | 鬟朱勦 <span class='chip ").append(riskCss).append("'>").append(escape(riskText(card.risk))).append("</span></div>");
            if (card.plan.valid && (isClose || !hideEntryInIntraday)) {
                sb.append("<div class='small'>蜈･蝨ｺ ").append(fmt2(card.plan.entryLow)).append(" ~ ").append(fmt2(card.plan.entryHigh))
                        .append(" | 豁｢謐・").append(formatPlanLevelWithDelta(card.plan.stopLoss, card.latestPrice, true))
                        .append(" | 逶ｮ譬・").append(formatPlanLevelWithDelta(card.plan.takeProfit, card.latestPrice, false))
                        .append(" | 逶井ｺ乗ｯ・").append(fmt2(card.plan.rrRatio)).append("</div>");
            } else if (card.plan.valid) {
                sb.append("<div class='small'>豁｢謐・").append(formatPlanLevelWithDelta(card.plan.stopLoss, card.latestPrice, true)).append("</div>");
            } else {
                sb.append("<div class='small'>隶｡蛻呈裏謨茨ｼ夊｡梧ュ/謖・・ｼｺ螟ｱ・壻ｻ頑律莉・ｧょｯ滂ｼ御ｸ堺ｺ､譏・/div>");
            }
            sb.append("<details><summary class='small'>signals</summary><ul class='bul'>");
            for (String reason : card.reasons) {
                sb.append("<li>").append(escape(reason)).append("</li>");
            }
            sb.append("</ul></details></div>");
        }
    }

    private void appendTopCards(StringBuilder sb, CandidateSelection topSelection, boolean isClose, boolean hideEntryInIntraday, Diagnostics diagnostics) {
        sb.append("<h2>E. 莉頑律 Top 5 蛟咎・/h2>");
        appendTopFunnel(sb, topSelection.funnel, topSelection.skipReason, diagnostics);

        if (topSelection.cards.isEmpty()) {
            sb.append("<div class='warnbox'>");
            if (!safe(topSelection.skipReason).isEmpty()) {
                sb.append(escape(topSelection.skipReason));
            } else {
                sb.append("蠖灘燕豐｡譛画ｻ｡雜ｳ隗・・逧・Top 5 蛟咎会ｼ亥ｷｲ陲ｫ gate 謌冶ｧ・・霑・ｻ､・峨・);
            }
            if (!topSelection.funnel.mainReasons.isEmpty()) {
                sb.append("<br>荳ｻ隕∵ｷ俶ｱｰ蜴溷屏・・).append(escape(String.join("・・, topSelection.funnel.mainReasons)));
            }
            sb.append("</div>");
        } else {
            for (CandidateCard card : topSelection.cards) {
                String riskCss = card.risk.grade == RiskGrade.HIGH ? "bad" : (card.risk.grade == RiskGrade.MID ? "warn" : "good");
                sb.append("<div class='card'><div><b>#").append(card.rank).append(" ").append(escape(card.name)).append("</b></div>");
                sb.append("<div class='small'>譛譁ｰ莉ｷ ").append(fmt2(card.latestPrice))
                        .append(" | 扈ｼ蜷亥・ <span class='chip info'>").append(fmt1(card.score)).append("</span>")
                        .append(" | 鬟朱勦 <span class='chip ").append(riskCss).append("'>").append(escape(riskText(card.risk))).append("</span></div>");
                if (!card.risk.tags.isEmpty()) {
                    sb.append("<div class='small'>鬟朱勦譬・ｭｾ・・).append(escape(String.join(", ", card.risk.tags))).append("</div>");
                }
                if (isClose || !hideEntryInIntraday) {
                    if (card.plan.valid) {
                        sb.append("<div class='small'>蜈･蝨ｺ蛹ｺ髣ｴ・・).append(fmt2(card.plan.entryLow)).append(" ~ ").append(fmt2(card.plan.entryHigh))
                                .append(" | 豁｢謐滉ｽ搾ｼ・).append(fmt2(card.plan.stopLoss))
                                .append(" | 逶ｮ譬・ｽ搾ｼ・).append(fmt2(card.plan.takeProfit))
                                .append(" | 逶井ｺ乗ｯ費ｼ・).append(fmt2(card.plan.rrRatio)).append("</div>");
                    } else {
                        sb.append("<div class='small'>莉ｷ菴肴婿譯井ｸ榊庄逕ｨ・・LAN_UNAVAILABLE・峨・/div>");
                    }
                } else {
                    String change = card.isNewCandidate ? "譁ｰ蠅槫咎・ : "蟒ｶ扈ｭ蛟咎・;
                    String delta = card.scoreDelta == null ? "蛻・焚蜿伜喧・壽裏蜴・彰謨ｰ謐ｮ" : ("蛻・焚蜿伜喧・・ + signed(card.scoreDelta));
                    String stopLine = card.plan.valid ? ("鬟朱勦郤ｿ(豁｢謐・・・ + fmt2(card.plan.stopLoss)) : "鬟朱勦郤ｿ(豁｢謐・・啀LAN_UNAVAILABLE";
                    sb.append("<div class='small'>").append(escape(change)).append(" | ").append(escape(delta)).append(" | ").append(escape(stopLine)).append("</div>");
                }
                sb.append("<ul class='bul'>");
                for (String reason : card.reasons) {
                    sb.append("<li>").append(escape(reason)).append("</li>");
                }
                sb.append("</ul></div>");
            }
        }

        if (!topSelection.excludedDerivatives.isEmpty()) {
            sb.append("<div class='warnbox'><b>陦咲函/蟇ｹ蜀ｲ邀ｻ・井ｻ・皮ｩｶ逕ｨ・・/b><br>蟾ｲ莉・Top 蛟咎牙鉛髯､・・)
                    .append(escape(String.join("; ", topSelection.excludedDerivatives)))
                    .append(".</div>");
        }
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendTopFunnel・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendTopFunnel(StringBuilder sb, TopFunnel funnel, String skipReason, Diagnostics diagnostics) {
        sb.append("<div class='card'><h3 style='margin-top:0;'>Top5 貍乗沫扈溯ｮ｡</h3><div class='small'>");
        sb.append("candidates_from_market_scan=").append(funnel.candidatesFromMarketScan).append(" | ");
        sb.append("excluded_derivatives=").append(funnel.excludedDerivatives).append(" | ");
        sb.append("missing_indicators=").append(funnel.missingIndicators).append(" | ");
        sb.append("plan_invalid=").append(funnel.planInvalid).append(" | ");
        sb.append("score_below_threshold=").append(funnel.scoreBelowThreshold).append(" | ");
        sb.append("final_top5_count=").append(funnel.finalTop5Count);
        sb.append("</div>");

        if (funnel.finalTop5Count == 0 && !funnel.mainReasons.isEmpty()) {
            sb.append("<div class='small'>譛荳ｻ隕∵ｷ俶ｱｰ蜴溷屏・・).append(escape(String.join("・・, funnel.mainReasons))).append("</div>");
        }
        if (!safe(skipReason).isEmpty()) {
            sb.append("<div class='small'>").append(escape(skipReason)).append("</div>");
        }
        if (diagnostics != null && !diagnostics.top5Gates.isEmpty()) {
            sb.append("<details><summary class='small'>Top5 gate reason tree</summary><div class='small'>");
            for (Diagnostics.GateTrace gate : diagnostics.top5Gates) {
                sb.append("gate=").append(escape(gate.gate))
                        .append(" | passed=").append(gate.passed)
                        .append(" | fail_count=").append(gate.failCount)
                        .append(" | threshold=").append(escape(blankTo(gate.threshold, "-")))
                        .append(" | cause_code=").append(gate.causeCode.name())
                        .append(" | owner=").append(escape(gate.owner))
                        .append(" | details=").append(escape(blankTo(gate.details, "-")))
                        .append("<br>");
            }
            sb.append("</div></details>");
        }
        sb.append("</div>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendDisclaimer・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendDisclaimer(StringBuilder sb) {
        sb.append("<h2>F. 鬟朱勦謠千､ｺ荳主・雍｣螢ｰ譏・/h2><div class='disclaimer'>");
        sb.append("1) 譛ｬ謚･蜻贋ｻ・畑莠主ｭｦ荵蜥檎皮ｩｶ・御ｸ肴桷謌先兜襍・ｻｺ隶ｮ縲・br>");
        sb.append("2) 隕・尠邇・ｽ惹ｺ・0%譌ｶ隸ｷ髯堺ｽ取揀驥搾ｼ御ｽ惹ｺ・0%譌ｶ荳榊ｻｺ隶ｮ謐ｮ豁､莠､譏薙・br>");
        sb.append("3) INTRADAY 莉・畑莠手ｧょｯ滂ｼ靴LOSE 謇肴署萓帛ｮ梧紛蜈･蝨ｺ/豁｢謐・逶ｮ譬・逶井ｺ乗ｯ斐・br>");
        sb.append("4) 謇譛我ｻｷ菴榊插荳ｺ讓｡蝙倶ｼｰ邂暦ｼ碁怙扈灘粋豬∝勘諤ｧ蜥碁｣朱勦謇ｿ蜿苓・蜉帙・br>");
        sb.append("</div>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendConfigOverview・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendConfigOverviewCollapsed(StringBuilder sb, Diagnostics diagnostics) {
        sb.append("<details><summary class='small'>鬮倡ｺｧ・壼盾謨ｰ諤ｻ隗茨ｼ育せ蠑・・/summary>");
        appendConfigOverview(sb, diagnostics);
        sb.append("</details>");
    }

    private void appendDiagnosticsCollapsed(StringBuilder sb, Diagnostics diagnostics) {
        sb.append("<details><summary class='small'>鬮倡ｺｧ・咼iagnostics・育せ蠑・・/summary>");
        appendDiagnostics(sb, diagnostics);
        sb.append("</details>");
    }

    private void appendConfigOverview(StringBuilder sb, Diagnostics diagnostics) {
        sb.append("<h2>G. 蜿よ焚諤ｻ隗茨ｼ域悽谺｡霑占｡鯉ｼ・/h2>");
        if (diagnostics == null || diagnostics.configSnapshot.isEmpty()) {
            sb.append("<div class='small'>譛ｪ驥・寔蛻ｰ蜿よ焚蠢ｫ辣ｧ縲・/div>");
            return;
        }
        sb.append("<div class='small'>莉･荳句盾謨ｰ譚･閾ｪ譛ｬ谺｡螳樣刔霑占｡碁・鄂ｮ・梧擂貅仙ｭ玲ｮｵ蜷ｫ荵会ｼ單efault/resource/override縲・/div>");
        sb.append("<table><tr><th>蜿よ焚</th><th>蠖灘燕蛟ｼ</th><th>譚･貅・/th><th>隸ｴ譏・/th></tr>");
        for (Diagnostics.ConfigItem item : diagnostics.configSnapshot.values()) {
            sb.append("<tr><td>")
                    .append(escape(item.key))
                    .append("</td><td>")
                    .append(escape(blankTo(item.value, "")))
                    .append("</td><td>")
                    .append(escape(blankTo(item.source, "default")))
                    .append("</td><td>")
                    .append(escape(configDesc(item.key)))
                    .append("</td></tr>");
        }
        sb.append("</table>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendDiagnostics・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendDiagnostics(StringBuilder sb, Diagnostics diagnostics) {
        if (diagnostics == null) {
            return;
        }
        sb.append("<h2>H. Diagnostics</h2>");
        sb.append("<details><summary>diagnostics</summary><div class='small'>");
        sb.append("run_id=").append(diagnostics.runId).append(" | run_mode=").append(escape(blankTo(diagnostics.runMode, "-"))).append("<br>");
        sb.append("coverage_scope=").append(escape(blankTo(diagnostics.coverageScope, "-")))
                .append(" | coverage_source=").append(escape(blankTo(diagnostics.coverageSource, "-")))
                .append(" | coverage_owner=").append(escape(blankTo(diagnostics.coverageOwner, "-"))).append("<br>");

        if (!diagnostics.coverages.isEmpty()) {
            sb.append("<b>coverage_metrics</b><br>");
            for (Diagnostics.CoverageMetric m : diagnostics.coverages.values()) {
                sb.append(escape(m.key))
                        .append(": ")
                        .append(m.numerator)
                        .append("/")
                        .append(m.denominator)
                        .append(" (")
                        .append(fmt1(m.pct))
                        .append("%)")
                        .append(" | source=")
                        .append(escape(blankTo(m.source, "-")))
                        .append(" | owner=")
                        .append(escape(blankTo(m.owner, "-")))
                        .append("<br>");
            }
        }

        if (!diagnostics.dataSourceStats.isEmpty()) {
            sb.append("<b>data_sources</b><br>");
            for (Map.Entry<String, Integer> e : diagnostics.dataSourceStats.entrySet()) {
                sb.append(escape(e.getKey())).append("=").append(e.getValue()).append("<br>");
            }
        }

        if (!diagnostics.featureStatuses.isEmpty()) {
            sb.append("<b>feature_status</b><br>");
            for (Map.Entry<String, FeatureResolution> e : diagnostics.featureStatuses.entrySet()) {
                sb.append(escape(e.getKey())).append(": ")
                        .append(escape(renderFeatureStatusSimple(e.getKey(), e.getValue())))
                        .append("<br>");
            }
        }

        if (!diagnostics.configSnapshot.isEmpty()) {
            sb.append("<b>config_snapshot</b><br>");
            for (Diagnostics.ConfigItem item : diagnostics.configSnapshot.values()) {
                sb.append(escape(item.key))
                        .append("=")
                        .append(escape(blankTo(item.value, "")))
                        .append(" (source=")
                        .append(escape(blankTo(item.source, "default")))
                        .append(")")
                        .append("<br>");
            }
        }

        if (!diagnostics.notes.isEmpty()) {
            sb.append("<b>notes</b><br>");
            for (String note : diagnostics.notes) {
                sb.append(escape(note)).append("<br>");
            }
        }
        sb.append("</div></details>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喘uildDebugJson・瑚ｴ溯ｴ｣譫・ｻｺ逶ｮ譬・ｯｹ雎｡謌冶ｾ灘・蜀・ｮｹ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String buildDebugJson(
            Instant startedAt,
            ZoneId zoneId,
            List<WatchlistAnalysis> watchlistCandidates,
            ScanResultSummary scanSummary,
            boolean marketScanPartial,
            String marketScanStatus,
            Diagnostics diagnostics
    ) {
        Diagnostics diag = diagnostics == null ? new Diagnostics(0L, "") : diagnostics;
        ScanResultSummary summary = scanSummary == null
                ? new ScanResultSummary(0, 0, 0, Map.of(), Map.of(), Map.of())
                : scanSummary;
        List<WatchlistAnalysis> watchRows = sortedWatch(watchlistCandidates);

        JSONObject root = new JSONObject();
        root.put("generated_at", startedAt == null || zoneId == null ? "" : startedAt.atZone(zoneId).toString());
        root.put("run_id", diag.runId);
        root.put("run_mode", safe(diag.runMode));
        root.put("market_scan_status", blankTo(marketScanStatus, "UNKNOWN"));
        root.put("market_scan_partial", marketScanPartial);
        root.put("coverage_scope", blankTo(diag.coverageScope, "MARKET"));
        root.put("coverage_source", blankTo(diag.coverageSource, "UNKNOWN"));

        JSONObject summaryJson = new JSONObject();
        summaryJson.put("total", summary.total);
        summaryJson.put("fetch_coverage", summary.fetchCoverage);
        summaryJson.put("indicator_coverage", summary.indicatorCoverage);
        root.put("scan_summary", summaryJson);

        JSONObject coverageJson = new JSONObject();
        for (Map.Entry<String, Diagnostics.CoverageMetric> e : diag.coverages.entrySet()) {
            coverageJson.put(e.getKey(), coverageToJson(e.getValue()));
        }
        root.put("coverages", coverageJson);

        JSONArray gates = new JSONArray();
        for (Diagnostics.GateTrace gate : diag.top5Gates) {
            JSONObject item = new JSONObject();
            item.put("gate", gate.gate);
            item.put("passed", gate.passed);
            item.put("fail_count", gate.failCount);
            item.put("threshold", gate.threshold);
            item.put("cause_code", gate.causeCode == null ? CauseCode.NONE.name() : gate.causeCode.name());
            item.put("owner", safe(gate.owner));
            item.put("details", safe(gate.details));
            gates.put(item);
        }
        root.put("top5_gates", gates);

        JSONArray rows = new JSONArray();
        for (WatchlistAnalysis row : watchRows) {
            JSONObject reasonRoot = safeJson(row.technicalReasonsJson);
            IndicatorData ind = parseIndicators(row.technicalIndicatorsJson, row.lastClose);
            Outcome<TradePlan> planOutcome = tradePlanBuilder.build(toTradePlanInput(ind));
            DisplayReason displayReason = resolveDisplayReason(row, reasonRoot, planOutcome);

            JSONObject details = reasonRoot.optJSONObject("details");
            if (details == null) {
                details = new JSONObject();
            }

            JSONObject item = new JSONObject();
            item.put("watch_item", safe(row.watchItem));
            item.put("ticker", safe(row.ticker));
            item.put("code", safe(row.code));
            item.put("resolved_market", safe(row.resolvedMarket));
            item.put("resolve_status", safe(row.resolveStatus));
            item.put("normalized_ticker", safe(row.normalizedTicker));
            item.put("technical_status", safe(row.technicalStatus));
            item.put("bars_count", row.barsCount);
            item.put("fetch_success", row.fetchSuccess);
            item.put("indicator_ready", row.indicatorReady);
            item.put("cause_code", displayReason.causeCode);
            item.put("owner", displayReason.owner);
            item.put("details", details);
            JSONObject memory = reasonRoot.optJSONObject("memory");
            item.put("memory", memory == null ? new JSONObject() : memory);
            item.put("display_category", displayReason.category);
            item.put("user_message", displayReason.userMessage);

            JSONObject planJson = new JSONObject();
            planJson.put("valid", planOutcome != null && planOutcome.success);
            if (planOutcome != null && !planOutcome.success) {
                planJson.put("cause_code", planOutcome.causeCode == null ? CauseCode.NONE.name() : planOutcome.causeCode.name());
                planJson.put("owner", safe(planOutcome.owner));
                planJson.put("details", new JSONObject(planOutcome.details));
            }
            item.put("plan", planJson);

            rows.put(item);
        }
        root.put("watchlist", rows);
        return root.toString(2);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喞overageToJson・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private JSONObject coverageToJson(Diagnostics.CoverageMetric metric) {
        JSONObject json = new JSONObject();
        if (metric == null) {
            json.put("numerator", 0);
            json.put("denominator", 0);
            json.put("pct", 0.0);
            json.put("source", "");
            json.put("owner", "");
            return json;
        }
        json.put("numerator", metric.numerator);
        json.put("denominator", metric.denominator);
        json.put("pct", round2(metric.pct));
        json.put("source", safe(metric.source));
        json.put("owner", safe(metric.owner));
        return json;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ppendWatchWhy・瑚ｴ溯ｴ｣霑ｽ蜉扈・｣・ｾ灘・迚・ｮｵ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private void appendWatchWhy(StringBuilder sb, DisplayReason displayReason) {
        if (displayReason == null) {
            return;
        }
        sb.append("<div class='small'><b>")
                .append(escape(displayReason.category))
                .append("</b>: ")
                .append(escape(displayReason.userMessage))
                .append("</div>");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗷esolveDisplayReason・瑚ｴ溯ｴ｣隗｣譫占ｧ・・蟷ｶ遑ｮ螳壽怙扈育ｻ捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private DisplayReason resolveDisplayReason(WatchlistAnalysis row, JSONObject reasonRoot, Outcome<TradePlan> planOutcome) {
        JSONObject root = reasonRoot == null ? new JSONObject() : reasonRoot;
        String causeRaw = root.optString("cause_code", row.fetchSuccess ? CauseCode.NONE.name() : CauseCode.FETCH_FAILED.name());
        CauseCode causeCode = toCauseCode(causeRaw);
        String owner = root.optString("owner", "com.stockbot.jp.runner.DailyRunner#scanWatchRecord(...)");
        JSONObject details = root.optJSONObject("details");
        if (details == null) {
            details = new JSONObject();
        }

        String category = "OK";
        String message = "Passed filters.";

        if (causeCode == CauseCode.TICKER_RESOLVE_FAILED) {
            category = "SYMBOL_ERROR";
            message = blankTo(details.optString("user_message", ""), "Symbol market mismatch: use ####.T (JP) or NVDA.US (US).");
        } else if ((causeCode == CauseCode.FETCH_FAILED || causeCode == CauseCode.NO_BARS) && row.barsCount <= 0) {
            category = "NO_MARKET_DATA";
            message = "No market data bars were fetched.";
        } else if (causeCode == CauseCode.HISTORY_SHORT) {
            category = "INSUFFICIENT_HISTORY";
            message = "History is too short for required indicators.";
        } else if (causeCode == CauseCode.INDICATOR_ERROR) {
            category = "INDICATOR_FAILURE";
            message = "Indicator calculation failed.";
        } else if (causeCode == CauseCode.PLAN_INVALID) {
            category = "PLAN_UNAVAILABLE";
            message = "Trade plan is unavailable.";
        } else if (causeCode == CauseCode.FILTER_REJECTED || causeCode == CauseCode.RISK_REJECTED || causeCode == CauseCode.SCORE_BELOW_THRESHOLD) {
            category = "REJECTED_BY_RULES";
            message = "Rejected by rules (" + filterReasonSummary(root) + ").";
        } else if (planOutcome != null && !planOutcome.success && planOutcome.causeCode == CauseCode.PLAN_INVALID) {
            category = "PLAN_UNAVAILABLE";
            message = "Trade plan is unavailable.";
        }

        return new DisplayReason(category, message, causeCode.name(), owner, details);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喃ilterReasonSummary・瑚ｴ溯ｴ｣謖芽ｧ・・霑・ｻ､譌謨域焚謐ｮ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String filterReasonSummary(JSONObject reasonRoot) {
        if (reasonRoot == null) {
            return "rule_not_met";
        }
        JSONArray reasons = reasonRoot.optJSONArray("filter_reasons");
        if (reasons == null || reasons.length() == 0) {
            return "rule_not_met";
        }
        List<String> items = new ArrayList<>();
        for (int i = 0; i < reasons.length(); i++) {
            String text = reasons.optString(i, "").trim();
            if (!text.isEmpty()) {
                items.add(text);
            }
            if (items.size() >= 2) {
                break;
            }
        }
        if (items.isEmpty()) {
            return "rule_not_met";
        }
        return String.join(", ", items);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗾oCauseCode・瑚ｴ溯ｴ｣霓ｬ謐｢謨ｰ謐ｮ扈捺桷逕ｨ莠主錘扈ｭ螟・炊縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private CauseCode toCauseCode(String raw) {
        if (raw == null || raw.trim().isEmpty()) {
            return CauseCode.NONE;
        }
        try {
            return CauseCode.valueOf(raw.trim().toUpperCase(Locale.ROOT));
        } catch (Exception ignored) {
            return CauseCode.NONE;
        }
    }
/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗷enderFeatureStatus・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String renderFeatureStatusV2(String featureKey, FeatureResolution feature, ScanResultSummary summary) {
        if (feature == null || feature.status != FeatureStatus.ENABLED) {
            return "隸･讓｡蝮玲悴蠑蜷ｯ・井ｸ榊ｽｱ蜩堺ｹｰ蜊紋ｿ｡蜿ｷ・悟宵譏ｯ蟆台ｺ・ｻ溯ｮ｡/隗｣驥奇ｼ・;
        }
        int shortCount = summary == null ? 0 : summary.insufficientCount(DataInsufficientReason.HISTORY_SHORT);
        if (shortCount > 0) {
            return "陦梧ュ/謖・・ｼｺ螟ｱ・壻ｻ頑律莉・ｧょｯ滂ｼ御ｸ堺ｺ､譏・;
        }
        double winRate = config.getDouble("report.metrics.top5_perf.win_rate_30d", Double.NaN);
        double drawdown = config.getDouble("report.metrics.top5_perf.max_drawdown_30d", Double.NaN);
        if (Double.isFinite(winRate) || Double.isFinite(drawdown)) {
            return "霑・0螟ｩ閭懃紫 " + fmt1(winRate) + "% | 譛螟ｧ蝗樊彫 " + fmt1(drawdown) + "%";
        }
        return "蟾ｲ蜷ｯ逕ｨ";
    }

    private String renderFeatureStatus(String featureKey, FeatureResolution feature, ScanResultSummary summary) {
        if (feature == null) {
            return "<b>譛ｪ蜷ｯ逕ｨ</b>";
        }
        if (feature.status == FeatureStatus.ENABLED) {
            int shortCount = summary == null ? 0 : summary.insufficientCount(DataInsufficientReason.HISTORY_SHORT);
            if (shortCount > 0) {
                return "<b>INSUFFICIENT_HISTORY</b>・・ause_code=HISTORY_SHORT・経wner=com.stockbot.jp.db.ScanResultDao#summarizeByRun(...)・系=" + shortCount + "・・;
            }
            double winRate = config.getDouble("report.metrics.top5_perf.win_rate_30d", Double.NaN);
            double drawdown = config.getDouble("report.metrics.top5_perf.max_drawdown_30d", Double.NaN);
            if (Double.isFinite(winRate) || Double.isFinite(drawdown)) {
                return "<b>" + fmt1(winRate) + "%</b>・幄ｿ・0譌･譛螟ｧ蝗樊彫・・b>" + fmt1(drawdown) + "%</b>";
            }
            return "<b>蟾ｲ蜷ｯ逕ｨ</b>";
        }
        if (feature.status == FeatureStatus.DISABLED_BY_CONFIG) {
            return "<b>譛ｪ蜷ｯ逕ｨ</b>・・onfig: " + featureKey + "=false・・;
        }
        if (feature.status == FeatureStatus.DISABLED_NOT_IMPLEMENTED) {
            return "<b>譛ｪ蜷ｯ逕ｨ</b>・・ause_code=" + feature.causeCode.name() + "・経wner=" + escape(feature.owner) + "・・;
        }
        return "<b>譛ｪ蜷ｯ逕ｨ</b>・・untime_error=" + escape(blankTo(feature.runtimeExceptionClass, "unknown")) + "・・;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗷enderFeatureStatusSimple・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String renderFeatureStatusSimple(String featureKey, FeatureResolution feature) {
        if (feature == null) {
            return "disabled (unknown)";
        }
        if (feature.status == FeatureStatus.ENABLED) {
            return "enabled";
        }
        if (feature.status == FeatureStatus.DISABLED_BY_CONFIG) {
            return "disabled_by_config (" + featureKey + "=false)";
        }
        if (feature.status == FeatureStatus.DISABLED_NOT_IMPLEMENTED) {
            return "disabled_not_implemented (cause_code=" + feature.causeCode.name() + ", owner=" + feature.owner + ")";
        }
        return "disabled_runtime_error (" + blankTo(feature.runtimeExceptionClass, "unknown") + ")";
    }
/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖ortedWatch・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private List<WatchlistAnalysis> sortedWatch(List<WatchlistAnalysis> rows) {
        if (rows == null || rows.isEmpty()) return List.of();
        List<WatchlistAnalysis> out = new ArrayList<>(rows);
        out.sort(Comparator.comparingDouble((WatchlistAnalysis x) -> x.technicalScore).reversed());
        return out;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖ortedMarket・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private List<ScoredCandidate> sortedMarket(List<ScoredCandidate> rows) {
        if (rows == null || rows.isEmpty()) return List.of();
        List<ScoredCandidate> out = new ArrayList<>(rows);
        out.sort(Comparator.comparingDouble((ScoredCandidate x) -> x.score).reversed());
        return out;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喘uildTopSelection・瑚ｴ溯ｴ｣譫・ｻｺ逶ｮ譬・ｯｹ雎｡謌冶ｾ灘・蜀・ｮｹ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private CandidateSelection buildTopSelection(
            List<ScoredCandidate> rows,
            RunType runType,
            Map<String, Double> prev,
            double minScore,
            int limit,
            int candidateSize,
            boolean marketScanPartial,
            double fetchCoveragePct,
            String marketScanStatus,
            Diagnostics diagnostics
    ) {
        TopFunnel funnel = new TopFunnel();
        funnel.candidatesFromMarketScan = Math.max(0, candidateSize);

        boolean skipOnPartial = config.getBoolean("report.top5.skip_on_partial", true);
        double minFetchCoverage = config.getDouble("report.top5.min_fetch_coverage_pct", 80.0);
        double allowPartialWhenCoverageGe = config.getDouble("report.top5.allow_partial_when_coverage_ge", 101.0);
        boolean partialBlocked = skipOnPartial && marketScanPartial && fetchCoveragePct < allowPartialWhenCoverageGe;
        if (diagnostics != null) {
            diagnostics.addTop5Gate(
                    "skip_on_partial",
                    !partialBlocked,
                    partialBlocked ? Math.max(0, candidateSize) : 0,
                    "report.top5.skip_on_partial=true && report.top5.allow_partial_when_coverage_ge=" + fmt1(allowPartialWhenCoverageGe),
                    CauseCode.GATE_SKIP_ON_PARTIAL,
                    OWNER_TOP5,
                    "market_scan_status=" + blankTo(marketScanStatus, "UNKNOWN") + ", fetch_coverage_pct=" + fmt1(fetchCoveragePct)
            );
        }
        if (partialBlocked || fetchCoveragePct < minFetchCoverage) {
            if (diagnostics != null) {
                diagnostics.addTop5Gate(
                        "min_fetch_coverage_pct",
                        fetchCoveragePct >= minFetchCoverage,
                        fetchCoveragePct < minFetchCoverage ? Math.max(0, candidateSize) : 0,
                        "report.top5.min_fetch_coverage_pct=" + fmt1(minFetchCoverage),
                        CauseCode.GATE_MIN_FETCH_COVERAGE,
                        OWNER_TOP5,
                        "fetch_coverage_pct=" + fmt1(fetchCoveragePct)
                );
            }
            String reason = partialBlocked
                    ? ("Top5・夊ｷｳ霑・ｼ・can=" + blankTo(marketScanStatus, "PARTIAL") + " 荳・coverage="
                    + fmt1(fetchCoveragePct) + "% < " + fmt1(minFetchCoverage) + "%・・)
                    : ("Top5・夊ｷｳ霑・ｼ・overage=" + fmt1(fetchCoveragePct) + "% < " + fmt1(minFetchCoverage) + "%・・);
            funnel.mainReasons = List.of(reason);
            return new CandidateSelection(List.of(), List.of(), funnel, reason);
        }
        if (diagnostics != null) {
            diagnostics.addTop5Gate(
                    "min_fetch_coverage_pct",
                    true,
                    0,
                    "report.top5.min_fetch_coverage_pct=" + fmt1(minFetchCoverage),
                    CauseCode.NONE,
                    OWNER_TOP5,
                    "fetch_coverage_pct=" + fmt1(fetchCoveragePct)
            );
        }

        List<CandidateCard> cards = new ArrayList<>();
        List<String> excluded = new ArrayList<>();
        int rank = 1;

        for (ScoredCandidate c : rows) {
            if (c == null) continue;
            if (c.score < minScore) {
                funnel.scoreBelowThreshold++;
                continue;
            }
            if (isDerivative(c)) {
                funnel.excludedDerivatives++;
                excluded.add(candidateName(c));
                continue;
            }

            IndicatorData ind = parseIndicators(c.indicatorsJson, c.close);
            if (!ind.hasRiskInputs()) {
                funnel.missingIndicators++;
                continue;
            }

            Outcome<TradePlan> planOutcome = tradePlanBuilder.build(toTradePlanInput(ind));
            TradePlan plan = planOutcome.value == null ? TradePlan.invalid() : planOutcome.value;
            if (runType == RunType.CLOSE && !plan.valid) {
                funnel.planInvalid++;
                continue;
            }

            RiskAssessment risk = assessRisk(ind);
            List<String> reasons = normalizeReasons(c.reasonsJson, 3);
            if (reasons.isEmpty()) reasons = List.of("DATA_GAP");
            String key = safeTickerKey(c.ticker);
            Double old = prev == null ? null : prev.get(key);
            cards.add(new CandidateCard(rank++, candidateName(c), c.score, ind.lastClose, risk, reasons, plan, old == null, old == null ? null : c.score - old));
            if (cards.size() >= limit) break;
        }

        funnel.finalTop5Count = cards.size();
        if (cards.isEmpty()) {
            List<String> reasons = new ArrayList<>();
            if (funnel.missingIndicators > 0) reasons.add("missing_indicators n=" + funnel.missingIndicators);
            if (funnel.planInvalid > 0) reasons.add("plan_invalid n=" + funnel.planInvalid);
            if (funnel.excludedDerivatives > 0) reasons.add("excluded_derivatives n=" + funnel.excludedDerivatives);
            if (funnel.scoreBelowThreshold > 0) reasons.add("score_below_threshold n=" + funnel.scoreBelowThreshold);
            if (reasons.size() > 2) reasons = reasons.subList(0, 2);
            funnel.mainReasons = reasons;
        }
        if (diagnostics != null) {
            diagnostics.addTop5Gate(
                    "missing_indicators",
                    funnel.missingIndicators == 0,
                    funnel.missingIndicators,
                    "-",
                    CauseCode.MISSING_INDICATORS,
                    OWNER_TOP5,
                    "requires indicator fields for risk and plan"
            );
            diagnostics.addTop5Gate(
                    "plan_invalid",
                    funnel.planInvalid == 0,
                    funnel.planInvalid,
                    "runType=CLOSE",
                    CauseCode.PLAN_INVALID,
                    OWNER_TOP5,
                    "trade plan validation failed"
            );
            diagnostics.addTop5Gate(
                    "score_below_threshold",
                    funnel.scoreBelowThreshold == 0,
                    funnel.scoreBelowThreshold,
                    "scan.min_score=" + fmt1(minScore),
                    CauseCode.SCORE_BELOW_THRESHOLD,
                    OWNER_TOP5,
                    "candidate score below threshold"
            );
        }

        return new CandidateSelection(cards, excluded, funnel, "");
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗔arseIndicators・瑚ｴ溯ｴ｣隗｣譫占ｾ灘・蜀・ｮｹ蟷ｶ霓ｬ謐｢扈捺桷縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private IndicatorData parseIndicators(String json, double fallbackClose) {
        JSONObject root = safeJson(json);
        double last = finitePositive(root.optDouble("last_close", Double.NaN), fallbackClose);
        double sma20 = finitePositive(root.optDouble("sma20", Double.NaN), Double.NaN);
        double sma60 = finitePositive(root.optDouble("sma60", Double.NaN), Double.NaN);
        double sma60Prev5 = finitePositive(root.optDouble("sma60_prev5", Double.NaN), Double.NaN);
        double avgVol20 = finitePositive(root.optDouble("avg_volume20", Double.NaN), Double.NaN);
        double volRatio = root.optDouble("volatility20_ratio", Double.NaN);
        if (!Double.isFinite(volRatio)) {
            double volPct = root.optDouble("volatility20_pct", Double.NaN);
            volRatio = Double.isFinite(volPct) ? volPct / 100.0 : Double.NaN;
        }
        double atr14 = finitePositive(root.optDouble("atr14", Double.NaN), Double.NaN);
        double lowLookback = finitePositive(root.optDouble("low_lookback", Double.NaN), Double.NaN);
        double highLookback = finitePositive(root.optDouble("high_lookback", Double.NaN), Double.NaN);
        if (!Double.isFinite(lowLookback)) lowLookback = finitePositive(root.optDouble("bollinger_lower", Double.NaN), Double.NaN);
        if (!Double.isFinite(highLookback)) highLookback = finitePositive(root.optDouble("bollinger_upper", Double.NaN), Double.NaN);
        return new IndicatorData(last, sma20, sma60, sma60Prev5, avgVol20, volRatio, atr14, lowLookback, highLookback);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾ssessRisk・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private RiskAssessment assessRisk(IndicatorData ind) {
        double minVol = config.getDouble("risk.minVolume", 50000.0);
        double volMax = config.getDouble("risk.volMax", 0.06);
        boolean high = false;
        boolean mid = false;
        boolean missing = false;
        List<String> tags = new ArrayList<>();

        if (!Double.isFinite(ind.avgVolume20)) {
            missing = true;
        } else if (ind.avgVolume20 < minVol) {
            high = true;
            tags.add("LOW_LIQ");
        }
        if (!Double.isFinite(ind.volatility20Ratio)) {
            missing = true;
        } else if (ind.volatility20Ratio > volMax) {
            high = true;
            tags.add("HIGH_VOL");
        }
        if (!Double.isFinite(ind.lastClose) || !Double.isFinite(ind.sma60) || !Double.isFinite(ind.sma60Prev5)) {
            missing = true;
        } else if (ind.lastClose < ind.sma60 && ind.sma60 < ind.sma60Prev5) {
            mid = true;
            tags.add("DOWN_TREND");
        }

        if (tags.isEmpty() && missing) tags.add("DATA_GAP");
        if (tags.size() > 2) tags = new ArrayList<>(tags.subList(0, 2));

        RiskGrade grade = high ? RiskGrade.HIGH : (mid ? RiskGrade.MID : RiskGrade.LOW);
        if (missing && grade == RiskGrade.LOW) grade = RiskGrade.MID;
        return new RiskAssessment(grade, tags, missing);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗾oTradePlanInput・瑚ｴ溯ｴ｣霓ｬ謐｢謨ｰ謐ｮ扈捺桷逕ｨ莠主錘扈ｭ螟・炊縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private TradePlanBuilder.Input toTradePlanInput(IndicatorData ind) {
        return new TradePlanBuilder.Input(
                ind.lastClose,
                ind.sma20,
                ind.lowLookback,
                ind.highLookback,
                ind.atr14
        );
    }
/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗜ormalizeReasons・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private List<String> normalizeReasons(String reasonsJson, int maxItems) {
        JSONObject root = safeJson(reasonsJson);
        JSONArray arr = root.optJSONArray("filter_reasons");
        if (arr == null || arr.length() == 0) return List.of();
        Set<String> out = new LinkedHashSet<>();
        for (int i = 0; i < arr.length(); i++) {
            String raw = arr.optString(i, "").trim().toLowerCase(Locale.ROOT);
            if (raw.isEmpty()) continue;
            out.add(raw.toUpperCase(Locale.ROOT));
            if (out.size() >= maxItems) break;
        }
        return new ArrayList<>(out);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啾iSummaryLines・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private List<String> aiSummaryLines(WatchlistAnalysis row) {
        List<String> out = new ArrayList<>();
        String summary = normalizeAiSummaryText(row.aiSummary);
        if (summary.isEmpty()) {
            out.add("1) 莉頑律蜈ｳ髞ｮ莠倶ｻｶ・壽嘯譌謨ｰ謐ｮ");
            out.add("2) 蛻ｩ螂ｽ/蛻ｩ遨ｺ・壽嘯譌謨ｰ謐ｮ/證よ裏謨ｰ謐ｮ");
            out.add("3) 蜈ｳ豕ｨ轤ｹ・壽嘯譌謨ｰ謐ｮ");
            return out;
        }
        List<String> lines = toReadableLines(summary);
        if (lines.isEmpty()) {
            out.add(summary);
            return out;
        }
        out.addAll(lines);
        return out;
    }

    private String normalizeAiSummaryText(String raw) {
        String text = TextFormatter.cleanForEmail(blankTo(raw, ""));
        text = text
                .replaceAll("\\[(.+?)]\\((https?://[^)]+)\\)", "$1")
                .replaceAll("(?m)^\\s{0,3}[-*+窶｢]+\\s+", "")
                .replaceAll("`+", "")
                .replaceAll("\\\\n", "\n")
                .replaceAll("(?i)\\bunkown\\b", "unknown")
                .trim();
        if (isLowValueAiText(text)) {
            return "";
        }
        return text;
    }

    private String sanitizeInlineText(String raw) {
        String text = normalizeAiSummaryText(raw);
        if (isLowValueAiText(text)) {
            return "";
        }
        return text.replace("\r", " ").replace("\n", " ").trim();
    }

    private List<String> toReadableLines(String text) {
        List<String> out = new ArrayList<>();
        String normalized = blankTo(text, "").replace("\r\n", "\n").replace("\r", "\n");
        Set<String> seen = new LinkedHashSet<>();
        for (String part : normalized.split("\n")) {
            String line = part == null ? "" : part.trim();
            if (line.isEmpty()) {
                continue;
            }
            line = line.replaceAll("(?i)\\bunkown\\b", "未知")
                    .replaceAll("(?i)\\bunknown\\b", "未知")
                    .trim();
            if (isLowValueAiText(line)) {
                continue;
            }
            if (seen.add(line)) {
                out.add(line);
            }
        }
        return out;
    }

    private boolean isLowValueAiText(String text) {
        String normalized = blankTo(text, "").replace("\r", " ").replace("\n", " ").trim();
        if (normalized.isEmpty()) {
            return true;
        }
        String lower = normalized.toLowerCase(Locale.ROOT);
        if (lower.matches("^(unknown|unkown|n/?a|none|null|nil|--|-|\\(unknown\\))$")) {
            return true;
        }
        if (lower.startsWith("ai unavailable:") || lower.startsWith("ai skipped:")) {
            return true;
        }
        return lower.contains("legacy pipeline failed");
    }

    private WatchDecision decideForWatchAction(WatchlistAnalysis w, boolean isClose) {
        if (w == null) {
            return new WatchDecision("WAIT", "譌謨ｰ謐ｮ", "", null);
        }
        Outcome<TradePlan> outcome = tradePlanBuilder.buildForWatchlist(w);
        TradePlan plan = outcome != null && outcome.value != null ? outcome.value : TradePlan.invalid();
        String invalidPlanReason = plan.valid ? "" : ("隶｡蛻呈裏謨茨ｼ・ + (outcome == null || outcome.causeCode == null ? CauseCode.PLAN_INVALID.name() : outcome.causeCode.name()));

        String status = blankTo(w.technicalStatus, "").toUpperCase(Locale.ROOT);
        if ("NO_MARKET_DATA".equals(status) || w.barsCount <= 0 || !w.fetchSuccess) {
            return new WatchDecision("WAIT", "陦梧ュ郛ｺ螟ｱ・井ｸ堺ｺ､譏難ｼ・, "", plan);
        }
        if (!(Double.isFinite(w.lastClose) && w.lastClose > 0.0)) {
            return new WatchDecision("WAIT", "莉ｷ譬ｼ譌謨茨ｼ井ｸ堺ｺ､譏難ｼ・, "", plan);
        }
        if (isClose && plan.valid && w.lastClose <= plan.stopLoss) {
            return new WatchDecision("SELL", "霍檎ｴ豁｢謐・, invalidPlanReason, plan);
        }

        RiskAssessment risk = assessRisk(parseIndicators(w.technicalIndicatorsJson, w.lastClose));
        boolean highRisk = risk.grade == RiskGrade.HIGH || "HIGH".equalsIgnoreCase(blankTo(w.risk, ""));
        if (highRisk && w.technicalScore < 65.0) {
            return new WatchDecision("REDUCE", "鬟朱勦鬮倅ｸ碑ｯ・・襍ｰ蠑ｱ", invalidPlanReason, plan);
        }
        if ("CANDIDATE".equalsIgnoreCase(blankTo(w.technicalStatus, "")) && w.technicalScore >= 80.0) {
            return new WatchDecision("BUY", highRisk ? "蠑ｺ菫｡蜿ｷ菴・ｫ倬｣朱勦・壻ｻ・ｰ丈ｻ凪王3%" : "蠑ｺ菫｡蜿ｷ・壼・隶ｸ蟆丈ｻ凪王5%", invalidPlanReason, plan);
        }
        if (w.technicalScore >= 65.0) {
            return new WatchDecision("HOLD", "隸・・蟆壼庄・壽戟譛芽ｧょｯ・, "", plan);
        }
        return new WatchDecision("WAIT", "菫｡蜿ｷ荳崎ｶｳ・夊ｧよ悍", "", plan);
    }

    private WatchDecisionRow pickBestWatchDecision(List<WatchlistAnalysis> watchRows, boolean isClose) {
        if (watchRows == null || watchRows.isEmpty()) {
            return null;
        }
        WatchDecisionRow best = null;
        for (WatchlistAnalysis row : watchRows) {
            WatchDecision decision = decideForWatchAction(row, isClose);
            if ("WAIT".equals(decision.action)) {
                continue;
            }
            WatchDecisionRow current = new WatchDecisionRow(row, decision);
            if (best == null
                    || watchActionPriority(current.decision.action) > watchActionPriority(best.decision.action)
                    || (watchActionPriority(current.decision.action) == watchActionPriority(best.decision.action)
                    && (row == null ? 0.0 : row.technicalScore) > (best.row == null ? 0.0 : best.row.technicalScore))) {
                best = current;
            }
        }
        return best;
    }

    private int watchActionPriority(String action) {
        String a = blankTo(action, "WAIT").toUpperCase(Locale.ROOT);
        if ("SELL".equals(a)) return 6;
        if ("REDUCE".equals(a)) return 5;
        if ("BUY".equals(a)) return 4;
        if ("ADD".equals(a)) return 3;
        if ("HOLD".equals(a)) return 2;
        return 1;
    }

    private String watchActionCss(String action) {
        String a = blankTo(action, "WAIT").toUpperCase(Locale.ROOT);
        if ("SELL".equals(a) || "REDUCE".equals(a)) return "bad";
        if ("BUY".equals(a) || "ADD".equals(a)) return "good";
        if ("HOLD".equals(a)) return "info";
        return "gray";
    }

    private String noviceConclusion(double indicatorCoveragePct) {
        if (indicatorCoveragePct < 50.0) return "荳榊ｻｺ隶ｮ莠､譏難ｼ井ｻ・ｧょｯ滂ｼ・;
        if (indicatorCoveragePct < 80.0) return "蜈∬ｮｸ蟆丈ｻ楢ｯ募黒・亥黒逾ｨ竕､3%・・;
        return "蜈∬ｮｸ豁｣蟶ｸ莉謎ｽ搾ｼ亥黒逾ｨ竕､5%・・;
    }

    private boolean containsRiskTag(List<String> tags, String target) {
        if (tags == null || tags.isEmpty()) {
            return false;
        }
        for (String tag : tags) {
            if (blankTo(tag, "").equalsIgnoreCase(blankTo(target, ""))) {
                return true;
            }
        }
        return false;
    }

    private String plainCode(WatchlistAnalysis row) {
        if (row == null) return "";
        String code = blankTo(row.code, "").toUpperCase(Locale.ROOT);
        return code.isEmpty() ? blankTo(row.ticker, "").toUpperCase(Locale.ROOT) : code;
    }

    private String plainName(WatchlistAnalysis row) {
        if (row == null) return "";
        return blankTo(row.companyNameLocal, blankTo(row.displayName, ""));
    }

    private String safeText(String value) {
        return safe(value).replace("\r", " ").replace("\n", " ").trim();
    }

    private ActionAdvice actionAdviceV2(double fetchCoveragePct, double indicatorCoveragePct, int candidateCount, List<CandidateCard> cards) {
        if (indicatorCoveragePct < 50.0 || fetchCoveragePct < 50.0) {
            return new ActionAdvice("莉・ｧょｯ・, "bad", "陦梧ュ/謖・・ｼｺ螟ｱ・壻ｻ頑律莉・ｧょｯ滂ｼ御ｸ堺ｺ､譏・);
        }
        if (indicatorCoveragePct < 80.0) {
            return new ActionAdvice("蟆丈ｻ楢ｯ募黒", "warn", "隕・尠邇・ｸ闊ｬ・悟ｻｺ隶ｮ蜿ｪ蛛壼ｰ丈ｻ謎ｽ榊ｹｶ荳･譬ｼ豁｢謐・);
        }
        if (candidateCount <= 1) {
            return new ActionAdvice("莉・ｧょｯ・, "gray", "譛画譜菫｡蜿ｷ螟ｪ蟆托ｼ御ｻ雁､ｩ荳榊ｻｺ隶ｮ蠑譁ｰ莉・);
        }
        return new ActionAdvice("蜿ｯ謇ｧ陦・, "good", "隕・尠邇・ｭ｣蟶ｸ・悟庄蜿り・ｮ｡蛻呈鴬陦・);
    }

    private ActionAdvice actionAdvice(double fetchCoveragePct, double indicatorCoveragePct, int candidateCount, List<CandidateCard> cards) {
        double fetchLowPct = config.getDouble("report.advice.fetch_low_pct", 50.0);
        double indicatorLowPct = config.getDouble("report.advice.indicator_low_pct", 50.0);
        double fetchWarnPct = config.getDouble("report.advice.fetch_warn_pct", 80.0);
        int candidateTryMax = Math.max(1, config.getInt("report.advice.candidate_try_max", 4));
        double avgScoreTryThreshold = config.getDouble("report.advice.avg_score_try_threshold", 72.0);
        double avgScore = cards.isEmpty() ? 0.0 : cards.stream().mapToDouble(c -> c.score).average().orElse(0.0);
        if (fetchCoveragePct < fetchLowPct) {
            return new ActionAdvice("隗よ悍", "bad", "FETCH_COVERAGE 菴惹ｺ・ + fmt1(fetchLowPct) + "%・瑚ｦ・尠荳崎ｶｳ・御ｸ榊ｻｺ隶ｮ謐ｮ豁､莠､譏薙・);
        }
        if (indicatorCoveragePct < indicatorLowPct) {
            return new ActionAdvice("隹ｨ諷・, "warn", "INDICATOR_COVERAGE 蛛丈ｽ趣ｼ梧欠譬・ｼｺ螟ｱ霎・､壹・);
        }
        if (fetchCoveragePct < fetchWarnPct) {
            return new ActionAdvice("隹ｨ諷・, "warn", "FETCH_COVERAGE 蝨ｨ" + fmt1(fetchLowPct) + "%~" + fmt1(fetchWarnPct) + "%・梧焚謐ｮ荳榊ｮ梧紛縲・);
        }
        if (candidateCount <= 1) {
            return new ActionAdvice("隗よ悍", "gray", "蛟咎画焚驥剰ｿ・ｰ托ｼ御ｿ｡蜿ｷ荳崎ｶｳ縲・);
        }
        if (candidateCount <= candidateTryMax || avgScore < avgScoreTryThreshold) {
            return new ActionAdvice("蟆丈ｻ楢ｯ暮漠", "info", "菫｡蜿ｷ蠑ｺ蠎ｦ荳闊ｬ・悟ｻｺ隶ｮ蟆丈ｻ馴ｪ瑚ｯ√・);
        }
        return new ActionAdvice("豁｣蟶ｸ", "good", "隕・尠邇・ｸ主咎画焚驥丞插豁｣蟶ｸ縲・);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喞ountPriceSuspects・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private int countPriceSuspects(List<WatchlistAnalysis> rows) {
        int count = 0;
        if (rows == null) return 0;
        for (WatchlistAnalysis row : rows) {
            if (row != null && row.priceSuspect) count++;
        }
        return count;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗚oinSuspectTickers・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String joinSuspectTickers(List<WatchlistAnalysis> rows) {
        LinkedHashSet<String> out = new LinkedHashSet<>();
        if (rows != null) {
            for (WatchlistAnalysis row : rows) {
                if (row != null && row.priceSuspect) {
                    String code = blankTo(row.code, row.ticker).toUpperCase(Locale.ROOT);
                    if (!code.isEmpty()) out.add(code);
                }
            }
        }
        return out.isEmpty() ? "-" : String.join(", ", out);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗹atchName・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String watchName(WatchlistAnalysis row) {
        String code = blankTo(row.code, "").toUpperCase(Locale.ROOT);
        String name = blankTo(row.companyNameLocal, blankTo(row.displayName, blankTo(row.ticker, "")));
        return code.isEmpty() ? name : (code + " " + name);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喞andidateName・瑚ｴ溯ｴ｣蛻､譁ｭ譚｡莉ｶ譏ｯ蜷ｦ貊｡雜ｳ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String candidateName(ScoredCandidate c) {
        String code = blankTo(c.code, "").toUpperCase(Locale.ROOT);
        String name = blankTo(c.name, blankTo(c.ticker, ""));
        return code.isEmpty() ? name : (code + " " + name);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喨sDerivative・瑚ｴ溯ｴ｣蛻､譁ｭ譚｡莉ｶ譏ｯ蜷ｦ貊｡雜ｳ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private boolean isDerivative(ScoredCandidate c) {
        String text = (blankTo(c.name, "") + " " + blankTo(c.market, "") + " " + blankTo(c.code, "")).toUpperCase(Locale.ROOT);
        for (String kw : DERIVATIVE_KEYWORDS) {
            if (text.contains(kw.toUpperCase(Locale.ROOT))) return true;
        }
        return false;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖coreTier・瑚ｴ溯ｴ｣隶｡邂苓ｯ・・蟷ｶ霎灘・蛻・ｼ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String scoreTier(double score) {
        double focusThreshold = config.getDouble("report.score.tier.focus_threshold", 80.0);
        double observeThreshold = config.getDouble("report.score.tier.observe_threshold", 65.0);
        if (score >= focusThreshold) return "蜈ｳ豕ｨ";
        if (score >= observeThreshold) return "隗ょｯ・;
        return "蠑ｱ";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗷iskText・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String riskText(RiskAssessment risk) {
        return risk.grade == RiskGrade.HIGH ? "鬮・ : (risk.grade == RiskGrade.MID ? "荳ｭ" : "菴・);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖afeTickerKey・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String safeTickerKey(String ticker) {
        return blankTo(ticker, "").toLowerCase(Locale.ROOT);
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喞onfigDesc・瑚ｴ溯ｴ｣譬ｹ謐ｮ髞ｮ蜷崎ｿ泌屓蜿よ焚隸ｴ譏弱・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String configDesc(String key) {
        if (key == null || key.trim().isEmpty()) {
            return "-";
        }
        switch (key) {
            case "app.zone":
                return "霑占｡梧慮蛹ｺ";
            case "app.schedule.enabled":
                return "譏ｯ蜷ｦ蜷ｯ逕ｨ螳壽慮莉ｻ蜉｡";
            case "schedule.zone":
                return "隹・ｺｦ譌ｶ蛹ｺ";
            case "schedule.times":
            case "schedule.time":
                return "隹・ｺｦ隗ｦ蜿第慮髣ｴ";
            case "report.dir":
                return "謚･蜻願ｾ灘・逶ｮ蠖・;
            case "scan.top_n":
                return "蜈ｨ蟶ょ惻謇ｫ謠城ｻ倩ｮ､ TopN";
            case "scan.market_reference_top_n":
                return "蟶ょ惻蜿り・咎画焚驥・;
            case "scan.min_score":
                return "譛蟆丞・騾牙・謨ｰ";
            case "scan.min_history_bars":
                return "譛蟆丞紙蜿ｲK郤ｿ謨ｰ驥・;
            case "scan.fresh_days":
                return "陦梧ュ謨ｰ謐ｮ蜈∬ｮｸ逧・怙螟ｧ貊槫錘螟ｩ謨ｰ";
            case "scan.cache.fresh_days":
                return "郛灘ｭ俶焚謐ｮ蜈∬ｮｸ逧・怙螟ｧ貊槫錘螟ｩ謨ｰ";
            case "backtest.hold_days":
                return "鬚・ｵ句捉譛滂ｼ域戟譛牙､ｩ謨ｰ・・;
            case "report.top5.skip_on_partial":
                return "驛ｨ蛻・沖謠乗慮譏ｯ蜷ｦ霍ｳ霑Ⅰop5";
            case "report.top5.min_fetch_coverage_pct":
                return "Top5譛蟆乗鞄蜿冶ｦ・尠邇・;
            case "report.top5.allow_partial_when_coverage_ge":
                return "驛ｨ蛻・沖謠乗叛陦碁・蛟ｼ";
            case "report.metrics.top5_perf.enabled":
                return "譏ｯ蜷ｦ蜷ｯ逕ｨTop5扈ｩ謨域欠譬・;
            case "report.metrics.top5_perf.win_rate_30d":
                return "Top5霑・0譌･閭懃紫";
            case "report.metrics.top5_perf.max_drawdown_30d":
                return "Top5霑・0譌･譛螟ｧ蝗樊彫";
            case "report.coverage.show_scope":
                return "譏ｯ蜷ｦ譏ｾ遉ｺ隕・尠邇・哨蠕・;
            case "report.mode.intraday.hideEntry":
                return "逶倅ｸｭ讓｡蠑城嚼阯丞・蝨ｺ菴・;
            case "report.advice.fetch_low_pct":
                return "陦悟勘蟒ｺ隶ｮ菴手ｦ・尠髦亥ｼ";
            case "report.advice.indicator_low_pct":
                return "陦悟勘蟒ｺ隶ｮ菴取欠譬・ｦ・尠髦亥ｼ";
            case "report.advice.fetch_warn_pct":
                return "陦悟勘蟒ｺ隶ｮ蜻願ｭｦ隕・尠髦亥ｼ";
            case "report.advice.candidate_try_max":
                return "蟆丈ｻ楢ｯ暮漠蛟咎画焚髦亥ｼ";
            case "report.advice.avg_score_try_threshold":
                return "蟆丈ｻ楢ｯ暮漠蟷ｳ蝮・・髦亥ｼ";
            case "report.score.tier.focus_threshold":
                return "蛻・ｱゑｼ壼・豕ｨ髦亥ｼ";
            case "report.score.tier.observe_threshold":
                return "蛻・ｱゑｼ夊ｧょｯ滄・蛟ｼ";
            case "filter.min_signals":
                return "遲幃画怙蟆丈ｿ｡蜿ｷ謨ｰ驥・;
            case "filter.hard.max_drop_3d_pct":
                return "3譌･譛螟ｧ蜈∬ｮｸ霍悟ｹ・;
            case "risk.max_atr_pct":
                return "鬟取而ATR荳企剞(%)";
            case "risk.max_volatility_pct":
                return "鬟取而豕｢蜉ｨ邇・ｸ企剞(%)";
            case "risk.max_drawdown_pct":
                return "鬟取而蝗樊彫荳企剞(%)";
            case "risk.min_volume_ratio":
                return "鬟取而譛蟆城㍼豈・;
            case "risk.fail_atr_multiplier":
                return "ATR隗ｦ蜿大､ｱ雍･蛟肴焚";
            case "risk.fail_volatility_multiplier":
                return "豕｢蜉ｨ邇・ｧｦ蜿大､ｱ雍･蛟肴焚";
            case "risk.penalty.atr_scale":
            case "risk.penalty.atr_cap":
            case "risk.penalty.volatility_scale":
            case "risk.penalty.volatility_cap":
            case "risk.penalty.drawdown_scale":
            case "risk.penalty.drawdown_cap":
            case "risk.penalty.liquidity":
                return "鬟朱勦諠ｩ鄂壼盾謨ｰ";
            case "rr.min":
                return "譛蟆冗寤莠乗ｯ・;
            case "plan.rr.min_floor":
                return "隶｡蛻呈怙蟆冗寤莠乗ｯ比ｸ矩剞";
            case "plan.entry.buffer_pct":
                return "蜈･蝨ｺ郛灘・逋ｾ蛻・ｯ・;
            case "plan.stop.atr_mult":
                return "豁｢謐蘗TR蛟肴焚";
            case "plan.target.high_lookback_mult":
                return "逶ｮ譬・ｻｷ蝗樒恚鬮倡せ邉ｻ謨ｰ";
            case "position.single.maxPct":
                return "邉ｻ扈溷黒逾ｨ莉謎ｽ堺ｸ企剞";
            case "position.total.maxPct":
                return "邉ｻ扈滓ｻ莉謎ｽ堺ｸ企剞";
            case "report.position.max_single_pct":
                return "謚･蜻雁黒逾ｨ莉謎ｽ堺ｸ企剞(%)";
            case "report.position.max_total_pct":
                return "謚･蜻頑ｻ莉謎ｽ堺ｸ企剞(%)";
            case "watchlist.path":
                return "閾ｪ騾芽ぃ譁・ｻｶ霍ｯ蠕・;
            case "watchlist.non_jp_handling":
                return "髱樊律閧｡螟・炊遲也払";
            case "watchlist.default_market_for_alpha":
                return "蟄玲ｯ堺ｻ｣遐・ｻ倩ｮ､蟶ょ惻";
            default:
                return "蜈ｳ髞ｮ霑占｡悟盾謨ｰ";
        }
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗾ile・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String tile(String key, String value) {
        return "<div class='tile'><div class='k'>" + escape(key) + "</div><div class='v'>" + value + "</div></div>";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖afeJson・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private JSONObject safeJson(String raw) {
        if (raw == null || raw.trim().isEmpty()) return new JSONObject();
        try {
            return new JSONObject(raw);
        } catch (Exception ignored) {
            return new JSONObject();
        }
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喃initePositive・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private double finitePositive(double first, double fallback) {
        if (Double.isFinite(first) && first > 0.0) return first;
        return (Double.isFinite(fallback) && fallback > 0.0) ? fallback : Double.NaN;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喞overagePct・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private double coveragePct(int universeSize, int scannedSize) {
        if (universeSize <= 0) return 0.0;
        return scannedSize * 100.0 / universeSize;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喃ormatCoverage・瑚ｴ溯ｴ｣譬ｼ蠑丞喧謨ｰ謐ｮ逕ｨ莠主ｱ慕､ｺ謌紋ｼ霎薙・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String formatCoverage(Diagnostics.CoverageMetric metric) {
        if (metric == null) {
            return "-";
        }
        return metric.numerator + " / " + metric.denominator + " (" + fmt1(metric.pct) + "%)";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗷ound2・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private double round2(double value) {
        return Math.round(value * 100.0) / 100.0;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喞lamp・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private double clamp(double value, double min, double max) {
        if (!Double.isFinite(value)) return min;
        if (value < min) return min;
        if (value > max) return max;
        return value;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喃mt1・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String fmt1(double value) {
        return Double.isFinite(value) ? String.format(Locale.US, "%.1f", value) : "-";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喃mt2・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String fmt2(double value) {
        return Double.isFinite(value) ? String.format(Locale.US, "%.2f", value) : "-";
    }

    private String formatPlanLevelWithDelta(double levelPrice, double latestPrice, boolean stopLoss) {
        if (!Double.isFinite(levelPrice) || levelPrice <= 0.0) {
            return "-";
        }
        String priceText = fmt2(levelPrice);
        if (!Double.isFinite(latestPrice) || latestPrice <= 0.0) {
            return priceText;
        }
        double pct = (levelPrice - latestPrice) / latestPrice * 100.0;
        String color = stopLoss ? "red" : (pct >= 0.0 ? "#15803d" : "red");
        return priceText + " <span style='color:" + color + "'>(" + String.format(Locale.US, "%+.1f", pct) + "%)</span>";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖igned・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String signed(double value) {
        return Double.isFinite(value) ? String.format(Locale.US, "%+.2f", value) : "-";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嗾rimText・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String trimText(String text, int maxLen) {
        String t = blankTo(text, "");
        if (t.length() <= maxLen) return t;
        return t.substring(0, Math.max(0, maxLen - 3)) + "...";
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喘lankTo・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String blankTo(String value, String fallback) {
        String t = value == null ? "" : value.trim();
        return t.isEmpty() ? fallback : t;
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ嘖afe・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String safe(String value) {
        return value == null ? "" : value.trim();
    }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ啼scape・瑚ｴ溯ｴ｣謇ｧ陦御ｸ壼苅騾ｻ霎大ｹｶ莠ｧ蜃ｺ扈捺棡縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
    private String escape(String text) {
        if (text == null) return "";
        return text.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;");
    }

    private static final class WatchDecision {
        final String action;
        final String reason1;
        final String reason2;
        final TradePlan plan;

        private WatchDecision(String action, String reason1, String reason2, TradePlan plan) {
            this.action = action == null || action.trim().isEmpty() ? "WAIT" : action.trim().toUpperCase(Locale.ROOT);
            this.reason1 = reason1 == null ? "" : reason1;
            this.reason2 = reason2 == null ? "" : reason2;
            this.plan = plan;
        }
    }

    private static final class WatchDecisionRow {
        final WatchlistAnalysis row;
        final WatchDecision decision;

        private WatchDecisionRow(WatchlistAnalysis row, WatchDecision decision) {
            this.row = row;
            this.decision = decision;
        }
    }

    private static final class DisplayReason {
        final String category;
        final String userMessage;
        final String causeCode;
        final String owner;
        final JSONObject details;

        private DisplayReason(String category, String userMessage, String causeCode, String owner, JSONObject details) {
            this.category = category == null ? "OK" : category;
            this.userMessage = userMessage == null ? "" : userMessage;
            this.causeCode = causeCode == null ? CauseCode.NONE.name() : causeCode;
            this.owner = owner == null ? "" : owner;
            this.details = details == null ? new JSONObject() : details;
        }
    }

    private static final class CandidateSelection {
        final List<CandidateCard> cards;
        final List<String> excludedDerivatives;
        final TopFunnel funnel;
        final String skipReason;

        private CandidateSelection(List<CandidateCard> cards, List<String> excludedDerivatives, TopFunnel funnel, String skipReason) {
            this.cards = cards == null ? List.of() : cards;
            this.excludedDerivatives = excludedDerivatives == null ? List.of() : excludedDerivatives.stream().limit(6).collect(Collectors.toList());
            this.funnel = funnel == null ? new TopFunnel() : funnel;
            this.skipReason = skipReason == null ? "" : skipReason;
        }
    }

    private static final class TopFunnel {
        int candidatesFromMarketScan;
        int excludedDerivatives;
        int missingIndicators;
        int planInvalid;
        int scoreBelowThreshold;
        int finalTop5Count;
        List<String> mainReasons = List.of();
    }

    private static final class CandidateCard {
        final int rank;
        final String name;
        final double score;
        final double latestPrice;
        final RiskAssessment risk;
        final List<String> reasons;
        final TradePlan plan;
        final boolean isNewCandidate;
        final Double scoreDelta;

        private CandidateCard(int rank, String name, double score, double latestPrice, RiskAssessment risk, List<String> reasons, TradePlan plan, boolean isNewCandidate, Double scoreDelta) {
            this.rank = rank;
            this.name = name;
            this.score = score;
            this.latestPrice = latestPrice;
            this.risk = risk;
            this.reasons = reasons == null ? List.of() : reasons;
            this.plan = plan;
            this.isNewCandidate = isNewCandidate;
            this.scoreDelta = scoreDelta;
        }
    }

    private static final class IndicatorData {
        final double lastClose;
        final double sma20;
        final double sma60;
        final double sma60Prev5;
        final double avgVolume20;
        final double volatility20Ratio;
        final double atr14;
        final double lowLookback;
        final double highLookback;

        private IndicatorData(double lastClose, double sma20, double sma60, double sma60Prev5, double avgVolume20, double volatility20Ratio, double atr14, double lowLookback, double highLookback) {
            this.lastClose = lastClose;
            this.sma20 = sma20;
            this.sma60 = sma60;
            this.sma60Prev5 = sma60Prev5;
            this.avgVolume20 = avgVolume20;
            this.volatility20Ratio = volatility20Ratio;
            this.atr14 = atr14;
            this.lowLookback = lowLookback;
            this.highLookback = highLookback;
        }

/**
 * 譁ｹ豕戊ｯｴ譏趣ｼ喇asRiskInputs・瑚ｴ溯ｴ｣蛻､譁ｭ譚｡莉ｶ譏ｯ蜷ｦ貊｡雜ｳ縲・
 * 螟・炊豬∫ｨ具ｼ壻ｼ夂ｻ灘粋蜈･蜿ゆｸ主ｽ灘燕荳贋ｸ区枚謇ｧ陦御ｸ壼苅騾ｻ霎托ｼ悟ｹｶ霑泌屓扈捺棡謌匁峩譁ｰ蜀・Κ迥ｶ諤√・
 * 扈ｴ謚､謠千､ｺ・夊ｰ・紛豁､譁ｹ豕墓慮蟒ｺ隶ｮ蜷梧ｭ･譽譟･隹・畑譁ｹ縲∝ｼょｸｸ蛻・髪荳取律蠢苓ｾ灘・縲・
 */
        private boolean hasRiskInputs() {
            return Double.isFinite(lastClose) && lastClose > 0.0
                    && Double.isFinite(avgVolume20)
                    && Double.isFinite(volatility20Ratio)
                    && Double.isFinite(sma60)
                    && Double.isFinite(sma60Prev5);
        }

    }

    private static final class RiskAssessment {
        final RiskGrade grade;
        final List<String> tags;
        final boolean insufficient;

        private RiskAssessment(RiskGrade grade, List<String> tags, boolean insufficient) {
            this.grade = grade;
            this.tags = tags == null ? List.of() : tags;
            this.insufficient = insufficient;
        }
    }

    private static final class ActionAdvice {
        final String level;
        final String css;
        final String reason;

        private ActionAdvice(String level, String css, String reason) {
            this.level = level;
            this.css = css;
            this.reason = reason;
        }
    }
}

