<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
  <th:block th:fragment="header(view)">
    <h1 th:text="${view.reportTitle}">StockBot Daily Report</h1>
    <h2>A. Header</h2>
    <div class="grid">
      <div class="tile" th:each="tile : ${view.topTiles}">
        <div class="k" th:text="${tile.key}">key</div>
        <div class="v" th:text="${tile.value}">value</div>
      </div>
    </div>
    <div class="dangerbox" th:if="${view.hasSuspectPrice}">Possible price mapping issue across tickers.</div>
    <div class="small" th:if="${view.hasSuspectPrice}">suspect tickers: <span th:text="${view.suspectTickers}">-</span></div>
    <div class="small" style="margin-top:8px">
      <span th:each="stat,iter : ${view.failureStats}">
        <span th:text="${stat}">-</span><span th:if="${!iter.last}"> | </span>
      </span>
    </div>
    <div class="small">coverage_source=<span th:text="${view.coverageSource}">UNKNOWN</span></div>
    <div class="small" th:if="${view.coverageMeta != null and !#lists.isEmpty(view.coverageMeta)}">
      <span th:each="meta,iter : ${view.coverageMeta}">
        <span th:text="${meta}">-</span><span th:if="${!iter.last}"> | </span>
      </span>
    </div>
    <div class="small" th:if="${view.partialMessage != null and !#strings.isEmpty(view.partialMessage)}" th:text="${view.partialMessage}"></div>
  </th:block>

  <th:block th:fragment="status(view)">
    <h2>B. System Status</h2>
    <div class="small">
      <div th:each="line : ${view.systemStatusLines}" th:text="${line}"></div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">Novice Summary</h3>
      <div class="small" th:each="line : ${view.noviceLines}" th:text="${line}"></div>
    </div>
    <div class="card">
      <div>
        Action level:
        <span class="chip" th:classappend="${view.actionAdvice.css}" th:text="${view.actionAdvice.level}">CHECK</span>
      </div>
      <div class="small" th:text="${view.actionAdvice.reason}"></div>
      <div class="small">
        Size cap single <span th:text="${view.actionAdvice.singleMaxPct}">5.0</span>% / total <span th:text="${view.actionAdvice.totalMaxPct}">50.0</span>%
      </div>
    </div>
    <details class="card" th:if="${view.moduleStatuses != null and !#lists.isEmpty(view.moduleStatuses)}">
      <summary class="small">Module status (expand)</summary>
      <div class="small" th:each="m : ${view.moduleStatuses}">
        <div><b th:text="${m.module}">module</b>: <span th:text="${m.status}">OK</span></div>
        <div th:text="${'reason: ' + m.reason}">reason</div>
        <div th:text="${'evidence: ' + m.evidence}">evidence</div>
      </div>
    </details>
  </th:block>

  <th:block th:fragment="watchlist(view)">
    <h2>C. Watchlist</h2>
    <div class="warnbox" th:if="${#lists.isEmpty(view.watchCards)}">No watchlist rows</div>
    <div class="card" th:each="card : ${view.watchCards}">
      <div>
        <b th:text="${card.name + ' (' + card.ticker + ')'}">Name(0000.T)</b>
        <span class="chip gray" th:text="${'Tech ' + card.trendStrength + '/100'}">Tech 0/100</span>
        <span class="chip good" th:text="${card.signal}">NEUTRAL</span>
        <span class="chip"
              th:classappend="${card.riskLevel == 'RISK' ? 'bad' : (card.riskLevel == 'IN' ? 'good' : 'warn')}"
              th:text="${card.riskLevel}">NEAR</span>
        <span class="chip"
              th:classappend="${card.dataStatus == 'OK' ? 'good' : (card.dataStatus == 'DEGRADED' ? 'warn' : 'bad')}"
              th:text="${card.dataStatus}">OK</span>
      </div>
      <div class="small">
        Price <span th:text="${card.price}">-</span>
        | MA5 <span th:text="${card.ma5}">-</span>
        | MA10 <span th:text="${card.ma10}">-</span>
        | MA20 <span th:text="${card.ma20}">-</span>
        | Bias <span th:text="${card.bias}">-</span>
        | VolRatio <span th:text="${card.volRatio}">-</span>
      </div>
      <div class="small">
        StopLine <span th:text="${card.stopLine}">-</span>
        | StopPct <span th:text="${card.stopPct}">-</span>
      </div>
      <ul>
        <li th:each="item : ${card.checklist}">
          <span class="chip"
                th:classappend="${item.status == 'FAIL' ? 'bad' : (item.status == 'PASS' ? 'good' : 'warn')}"
                th:text="${item.status}">WATCH</span>
          <span th:text="${item.label + ': ' + item.value + ' (' + item.rule + ')'}">rule</span>
        </li>
      </ul>
      <div class="small" th:text="${card.aiStatus + ' | ' + card.newsStatus}"></div>
      <details>
        <summary class="small">trace</summary>
        <div class="small" th:text="${card.traceSummary}">-</div>
      </details>
    </div>
  </th:block>

  <th:block th:fragment="topcards(view)">
    <h2>D. Top 5</h2>
    <div class="card">
      <div class="small">
        <span th:each="stat,iter : ${view.topCards.funnelStats}">
          <span th:text="${stat}"></span><span th:if="${!iter.last}"> | </span>
        </span>
      </div>
    </div>
    <div class="warnbox" th:if="${view.topCards.emptyMessage != null and !#strings.isEmpty(view.topCards.emptyMessage)}" th:text="${view.topCards.emptyMessage}"></div>
    <div class="card" th:each="card : ${view.topCards.cards}">
      <div>
        <b th:text="${'#' + card.rank + ' ' + card.name + ' (' + card.ticker + ')'}">#1 Name</b>
        <span class="chip gray" th:text="${'Tech ' + card.trendStrength + '/100'}">Tech 0/100</span>
        <span class="chip good" th:text="${card.signal}">NEUTRAL</span>
        <span class="chip"
              th:classappend="${card.riskLevel == 'RISK' ? 'bad' : (card.riskLevel == 'IN' ? 'good' : 'warn')}"
              th:text="${card.riskLevel}">NEAR</span>
      </div>
      <div class="small">
        Price <span th:text="${card.price}">-</span>
        | MA5 <span th:text="${card.ma5}">-</span>
        | MA10 <span th:text="${card.ma10}">-</span>
        | MA20 <span th:text="${card.ma20}">-</span>
        | Bias <span th:text="${card.bias}">-</span>
        | VolRatio <span th:text="${card.volRatio}">-</span>
      </div>
      <div class="small">
        StopLine <span th:text="${card.stopLine}">-</span>
        | StopPct <span th:text="${card.stopPct}">-</span>
        | Data <span th:text="${card.dataStatus}">OK</span>
      </div>
      <ul>
        <li th:each="item : ${card.checklist}">
          <span class="chip"
                th:classappend="${item.status == 'FAIL' ? 'bad' : (item.status == 'PASS' ? 'good' : 'warn')}"
                th:text="${item.status}">WATCH</span>
          <span th:text="${item.label + ': ' + item.value + ' (' + item.rule + ')'}">rule</span>
        </li>
      </ul>
    </div>
    <div class="card" th:if="${view.topCards.riskTop3 != null and !#lists.isEmpty(view.topCards.riskTop3)}">
      <h3 style="margin-top:0">Risk Top3</h3>
      <div th:each="row : ${view.topCards.riskTop3}" style="margin-bottom:8px">
        <div>
          <b th:text="${'#' + row.rank + ' ' + row.name}">#1 Ticker</b>
          <span class="chip bad" th:text="${row.riskLevel}">RISK</span>
          <span class="chip warn" th:text="${row.dataStatus}">MISSING</span>
        </div>
        <ul>
          <li th:each="r : ${row.reasons}" th:text="${r}">reason</li>
        </ul>
      </div>
    </div>
  </th:block>

  <th:block th:fragment="footer(view)">
    <h2>E. Notes</h2>
    <div class="small"><div th:each="line : ${view.disclaimerLines}" th:text="${line}"></div></div>
    <details>
      <summary class="small">Diagnostics</summary>
      <div class="small" th:if="${view.diagnostics.enabled}">
        <div th:text="${'run_id=' + view.diagnostics.runId + ' | business_run_mode=' + view.diagnostics.runMode}"></div>
        <div th:text="${'coverage_scope=' + view.diagnostics.coverageScope + ' | coverage_source=' + view.diagnostics.coverageSource}"></div>
      </div>
    </details>
    <div class="card" th:if="${view.runSummaryText != null and !#strings.isEmpty(view.runSummaryText)}">
      <h3 style="margin-top:0">Run Summary</h3>
      <pre class="small" style="white-space:pre-wrap" th:text="${view.runSummaryText}"></pre>
    </div>
  </th:block>
</body>
</html>
